# 2210.02747v2

## 1. 基本概念

**Continuous NormalizingFlows(CNFs)**
连续归一化流，能够建模任意概率路径，最知名的工作是扩散过程的概率路径建模。缺点：除了通过降噪得分匹配（denoising score matching）的扩散模型，没有可拓展的CNF训练算法。

**Flow Matching(FM)**
流匹配，高效的，无需模拟的训练CNF算法，使用通用概率路径来监督CNF训练。

**Flow Matching objective**
流匹配目标函数，一种简洁且直观的训练目标，用于将模型回归到一个目标向量场，该向量场能够生成所需的概率路径。

**Conditional Flow Matching (CFM)**
per-example training objective，逐个样本的训练目标。与降噪得分匹配有相等的梯度并且不需要对于难求解的目标向量场有显式的知识。

**Optimal Transport (OT) displacement interpolant**
最优传输位移插值函数，是一种向量场，对应的路径可以理解为一条直线。

注：向量场和流通过ODE一一对应。

## 2. 预备知识

\(\mathbb{R}^d\)  数据空间
\(x = (x^1, \ldots, x^d) \in \mathbb{R}^d\) 数据点
\(p : [0, 1] \times \mathbb{R}^d \to \mathbb{R}_{>0}\)  概率密度路径，依赖于时间的概率密度函数。记为\(p_t(x)\)
\(v : [0, 1] \times \mathbb{R}^d \to \mathbb{R}^d\)   向量场，依赖于时间，用于构建依赖于时间的微分同胚映射。记为\(v_t\)
\(\phi : [0, 1] \times \mathbb{R}^d \to \mathbb{R}^d\)  上述提到的映射，称为流（flow），记为\(\phi_t(x)\)，通过以下ODE定义
$$\frac{d}{dt}\phi_t(x) = v_t(\phi_t(x)) \tag{1}$$
$$\phi_0(x) = x \tag{2}$$

Chen et al. (2018) 提出用神经网络对向量场建模：\( v_t(x;\theta) \), 其中 \( \theta \in \mathbb{R}^p \)是可学习的参数。通过这个向量场可以得到流\(\phi_t\)的参数化模型，称为连续归一化流（CNF）。CNF可以将简单先验密度\( p_0 \)（比如纯噪声）转换为复杂的分布\( p_1 \)，通过前向方程：

$$p_t = [\phi_t]_* p_0 \tag{3}$$

前向方程的运算符 \( * \) 定义为
$$
[\phi_t]_* p_0(x)=p_0(\phi_t^{- 1}(x))\det\left[\frac{\partial\phi_t^{-1}}{\partial x}(x)\right].\tag{4}
$$

我们称向量场\( v_t \)生成概率密度路径\(p_t\)，如果这个向量场的流\( \phi_t \)满足等式3。
一种检验向量场是否生成概率路径的实用方法是利用连续性方程，该方程是我们证明中的一个关键组成部分，见附录 B。我们在附录 C 中回顾了关于连续归一化流（CNFs）的更多信息，尤其是如何在任意点\( x\in\mathbb{R}^d \)处计算概率\( p_1(x) \)  。

## 3. 流匹配
\(x_1 \sim q(x_1)\) 分布未知，只能得到从此分布采样到的数据。
\(p_t, t\in [0,1] \) 概率路径。其中\(p_0 = p\)是一个简单分布, 例如标准正态分布\(p(x)=N(x|0,I)\)，\(p_1\)近似于分布\(q\)。

流匹配的目的是匹配目标概率路径，从\(p_0\)流向\(p_1\)。

已知目标概率密度路径\(p_{t}(x)\)以及对应的向量场\(u_{t}(x)\)，定义流匹配目标函数为

\[\mathcal{L}_{FM}(\theta)=\mathbb{E}_{t, p_{t}(x)}\left\| v_{t}(x)-u_{t}(x)\right\| ^{2}, \tag{5}\]

其中\(\theta\)是连续归一化流向量场\(v_t\)。有\(t \sim U[0,1]\)，\(x \sim p_{t}(x)\)
简单来说，流匹配损失函数用一个神经网络\(v_t\)对向量场\(u_t\)进行回归。损失函数接近0时，学习到的CNF就会生成\(p_{t}(x)\)。

流匹配的目标是简单且有吸引力的，但是在实际应用中难以求解，因为没有\(u_t\)和\(p_t\)的先验知识。有很多概率路径满足\(p_{1}(x) \approx q(x)\)，而且我们普遍不知道用于生成\(p_{t}(x)\)的\(u_t\)的封闭形式。本节将证明，我们可以使用逐个样本定义的概率路径（即条件概率路径）和向量场构造\(p_{t}\)和\(u_{t}\)，并且通过适当的聚合方法可以得到所需的\(p_{t}\)和\(u_{t}\)。此外，这种构造方法使我们能够为流匹配构建一个更易于处理的目标函数。

## 3.1 从条件概率路径和向量场构造\(p_{t}\)，\(u_{t}\)

构建目标概率路径的一个简单方法，就是把简单的概率路径合成目标概率路径：给定一个样本\(x_{1}\)，条件概率路径记为\(p_{t}(x | x_{1})\)，它满足\(p_{0}(x | x_{1})=p(x)\)at \(t=0\)。\(p_{1}(x | x_{1})\) at \(t=1\) 是一个以\(x=x_{1}\)为中心（均值）的分布，例如\(p_{1}(x | x_{1})=N(x | x_{1}, \sigma^{2} I)\)，这个正态分布以\(x=x_{1}\)为均值，以足够小的\(\sigma>0\)为标准差
。这个条件概率路径在\(q(x_{1})\)上边缘化能够获得边缘概率路径

\[p_{t}(x)=\int p_{t}\left(x | x_{1}\right) q\left(x_{1}\right) d x_{1}, \tag{6}\]

特别的，对于\(t=1\)，边缘概率\(p_{1}\)是一个混合分布，近似于数据分布\(q\)。

\[p_{1}(x)=\int p_{1}\left(x | x_{1}\right) q\left(x_{1}\right) d x_{1} \approx q(x) . \tag{7}\]

证明：
\[
\begin{aligned} 
 \int p_{t}\left(x | x_{1}\right) q\left(x_{1}\right) d x_{1}  
& =\int \frac{p_{t}\left(x , x_{1}\right)}{q\left(x_{1}\right)} q\left(x_{1}\right) d x_{1} \\ 
& =\int {p_{t}\left(x , x_{1}\right)} d x_{1} \\ 
& =p_{t}(x) 
\end{aligned}
\]

证毕。

我们可以定义边缘向量场，通过在以下公式中对条件向量场边缘化：
 
\[u_{t}(x)=\int u_{t}\left(x | x_{1}\right) \frac{p_{t}\left(x | x_{1}\right) q\left(x_{1}\right)}{p_{t}(x)} d x_{1},\tag{8}\]

其中\(u_{t}(\cdot | x_{1}): \mathbb{R}^{d} \to \mathbb{R}^{d}\)是条件向量场，由它可以生成条件概率路径\(p_{t}(\cdot | x_{1})\)。这个定义看起来并不直观，但是这种计算条件向量场的方法确实可以推导出正确的，用于建模边缘概率路径的向量场。

本文第一个重要的观察是
>边缘向量场（8）生成边缘概率路径（6）。

这个观察在条件向量场（生成条件概率路径）和边缘向量场（生成边缘概率路径）之间建立了连接。这允许我们将未知的，难以解决的边缘向量场问题退化为简单，易于解决的条件向量场问题，因为后者只依赖于单个样本。以下定理正式提出了这一点。

**定理一** 给定条件向量场 \(u_{t}(x | x_{1})\)，由它生成条件概率路径\(p_{t}(x | x_{1})\)。对任意分布\(q(x_{1})\)，（8）中的边缘向量场\(u_{t}\)生成了（6）中的边缘概率路径\(p_{t}\)，即\(u_{t}\)和\(p_{t}\)满足连续性方程（26）。


## 3.2 条件流匹配
（6）和（8）中都有难解的积分，这导致计算\(u_{t}\)仍然是困难的，最终，计算原本的流匹配（FM）目标函数的无偏估计仍然是困难的。作为替代，本文提出一个更加简单的目标函数，参数的最优值和原本的目标函数相同。这就是条件流匹配（CFM）目标函数。

\[\mathcal{L}_{CFM}(\theta)=\mathbb{E}_{t, q\left(x_{1}\right), p_{t}\left(x | x_{1}\right)}\left\| v_{t}(x)-u_{t}\left(x | x_{1}\right)\right\| ^{2}, \tag{9}\]

其中 \(t \sim U[0,1]\)，\(x_{1} \sim q(x_{1})\),而且有\(x \sim p_{t}(x | x_{1})\)。与FM目标函数不同的是，CFM目标函数允许我们简单地采样无偏估计，只要我们能够高效地从\(p_{t}(x | x_{1})\)采样，并计算\(u_{t}(x | x_{1})\)。这两个任务都是简单的，因为他们都从逐个样本基础上定义而来。本文第二个重要的观察：
>FM(5)和CFM(9)目标函数关于\(\theta\)的梯度是相同的。

也就是说，优化条件流匹配（CFM）目标在期望上等同于优化流匹配（FM）目标。因此，我们能够训练连续归一化流（CNF）以生成条件概率路径\(p_{t}\)——特别是在\(t=1\)时逼近未知的数据分布\(q\)——而无需访问边缘概率路径或边缘向量场。我们只需要设计合适的条件概率路径和向量场。我们在下面的定理中对这一性质进行形式化阐述。

**定理二** 假设对于所有 \(x \in \mathbb{R}^{d}\)，\(t \in[0,1]\)，有\(p_{t}(x)>0\)，除了一个与\(\theta\)无关的常数，\(L_{C F M}\) 和 \(L_{F M}\)相等。因此它们的梯度相等，\(\nabla_{\theta} L_{F M}(\theta)=\nabla_{\theta} L_{C F M}(\theta)\)

# 4. 条件概率路径和向量场
条件流匹配（CFM）可以选择任何条件概率路径\(p_{t}(x | x_{1})\)和条件向量场\(u_{t}(x | x_{1})\)。本节讨论对于高斯条件概率路径族构建\(p_{t}(x | x_{1})\)和\(u_{t}(x | x_{1})\)。本节考虑的条件概率路径有以下形式：

\[p_{t}\left(x | x_{1}\right)=\mathcal{N}\left(x | \mu_{t}\left(x_{1}\right), \sigma_{t}\left(x_{1}\right)^{2} I\right), \tag{10}\]

其中\(\mu:[0,1] ×\mathbb{R}^{d} \to \mathbb{R}^{d}\)是依赖于时间的高斯分布均值，\(\sigma:\) \([0,1] ×\mathbb{R} \to \mathbb{R}_{>0}\)是依赖于时间的标准差。对于\(t = 0\)，设定\(\mu_{0}(x_{1})=0\)，\(\sigma_{0}(x_{1})=1\)，所以所有的条件概率路径在\(t = 0\)时都收敛到相同的标准高斯噪声分布，即\(p_{0}(x)=N(x | 0, I)\)。对于\(t = 1\)，设定\(\mu_{1}(x_{1})=x_{1}\)，\(\sigma_{1}(x_{1})=\sigma_{min }\)，这是一个充分小的标准差，最后，\(p_{1}(x | x_{1})\)是以 \(x_{1}\) 为中心的高斯分布。

存在无穷多个向量场可以生成任何特定的概率路径（例如，通过向连续性方程添加一个无散度分量），但其中绝大多数是由于存在使潜在分布保持不变的分量——例如，当分布是旋转不变时的旋转分量——这会导致不必要的额外计算。我们决定使用与高斯分布的正则变换相对应的最简单的向量场。具体来说，考虑以\(x_{1}\)为条件的流：

\[\psi_{t}(x)=\sigma_{t}\left(x_{1}\right) x+\mu_{t}\left(x_{1}\right) .\tag{11}\]

当\(x\)服从标准高斯分布时，\(\psi_{t}(x)\)是一种仿射变换，它将其映射为一个均值为\(\mu_{t}(x_{1})\)、标准差为\(\sigma_{t}(x_{1})\)的正态分布随机变量。也就是说，根据方程4，\(\psi_{t}\)将噪声分布从\(p_{0}(x | x_{1})=p(x)\)转换至\(p_{t}(x | x_{1})\)，即：

\[\left[\psi_{t}\right]_{*} p(x)=p_{t}\left(x | x_{1}\right) .\tag{12}\]

证明：
考虑一维变量的情形，由公式4

$$\left[\psi_{t}\right]_{*} p(x)= p(\psi_t^{- 1}(x))\det\left[\frac{\partial\psi_t^{-1}}{\partial x}(x)\right] $$

$$\psi_t^{- 1}(x) = \frac{x - \mu_{t}\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)}$$

\(p_{0}(x | x_{1})=p(x)\)是标准正态分布，由标准正态分布的密度函数

$$ p(x) = \frac{1}{\sqrt{2\pi}} e^{-\frac{x^2}{2}} $$

代入得
$$p(\psi_t^{- 1}(x)) = \frac{1}{\sqrt{2\pi}} exp\{-\frac{1}{2}(\frac{x - \mu_{t}\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)})^2\}$$

$$\frac{\partial\psi_t^{-1}}{\partial x}(x)  = \frac{\partial(\frac{x - \mu_{t}\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)})}{\partial x} = \frac{1}{\sigma_{t}\left(x_{1}\right)}$$

综上，结果是以上两式乘积

\[
\begin{aligned} 
 \left[\psi_{t}\right]_{*} p(x) &= p(\psi_t^{- 1}(x))\det\left[\frac{\partial\psi_t^{-1}}{\partial x}(x)\right] \\
 &= \frac{1}{\sqrt{2\pi}} exp\{-\frac{1}{2}(\frac{x - \mu_{t}\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)})^2\} \cdot \frac{1}{\sigma_{t}\left(x_{1}\right)}\\
 &= \frac{1}{\sqrt{2\pi}\sigma_{t}\left(x_{1}\right)} exp\{-\frac{1}{2}(\frac{x - \mu_{t}\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)})^2\}\\
 &= \mathcal{N}\left(x | \mu_{t}\left(x_{1}\right), \sigma_{t}\left(x_{1}\right)^{2} \right)\\
 &=p_{t}\left(x | x_{1}\right)
\end{aligned}
\]

证毕。

流与向量场之间的关系：

\[\frac{d}{d t} \psi_{t}(x)=u_{t}\left(\psi_{t}(x) | x_{1}\right) \tag{13}.\]

对于\(x_{0}\)重参数化\(p_{t}(x | x_{1})\)（即用\(x_{0}\)代入\(x\)），并将等式（13）插入CFM损失函数，可以得到：

\[\mathcal{L}_{CFM}(\theta)=\mathbb{E}_{t, q\left(x_{1}\right), p\left(x_{0}\right)}\left\| v_{t}\left(\psi_{t}\left(x_{0}\right)\right)-\frac{d}{d t} \psi_{t}\left(x_{0}\right)\right\| ^{2} . \tag{14}\]

\(\psi_{t}\)是一个简单，可逆的仿射变换，我们可以用等式（13）得到\(u_{t}\)的闭式解。对依赖于时间的函数\(f\) ，记它对于时间的导数为\(f'=\frac{d}{d t} f\) 。

**定理三** 令\(p_{t}(x | x_{1})\)是（10）中的概率路径，\(\psi_{t}\)是（11）中对应的流映射。那么，唯一的与\(\psi_{t}\)对应的向量场有如下形式：

\[u_{t}\left(x | x_{1}\right)=\frac{\sigma_{t}'\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)}\left(x-\mu_{t}\left(x_{1}\right)\right)+\mu_{t}'\left(x_{1}\right) . \tag{15}\]

总而言之，条件向量场\(u_{t}(x | x_{1})\)生成了高斯条件概率路径\(p_{t}(x | x_{1})\)

证明：
（11）对时间求导
$$\psi_{t}'(x)=\sigma_{t}'\left(x_{1}\right) x+\mu_{t}'\left(x_{1}\right)$$

上式代入（13）
$$\sigma_{t}'\left(x_{1}\right) x+\mu_{t}'\left(x_{1}\right) = u_{t}\left(\psi_{t}(x) | x_{1}\right)$$

将\(\psi_t^{- 1}(x)\)代入上式中的\(x\)

$$\sigma_{t}'\left(x_{1}\right) \psi_t^{- 1}(x)+\mu_{t}'\left(x_{1}\right) = u_{t}\left(\psi_{t}(\psi_t^{- 1}(x)) | x_{1}\right) = u_{t}\left(x | x_{1}\right)$$

然后由
$$\psi_t^{- 1}(x) = \frac{x - \mu_{t}\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)}$$

可以得到

\[
\begin{aligned} 
 u_{t}\left(x | x_{1}\right) &= \sigma_{t}'\left(x_{1}\right) \psi_t^{- 1}(x)+\mu_{t}'\left(x_{1}\right) \\
 &= \frac{\sigma_{t}'\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)}\left(x-\mu_{t}\left(x_{1}\right)\right)+\mu_{t}'\left(x_{1}\right)
\end{aligned}
\]

证毕。

## 4.1 高斯条件概率路径的特殊例子
在上述的流映射中，\(\mu_{t}(x_{1})\) 和 \(\sigma_{t}(x_{1})\)可以是任意可微且满足一定边界条件的函数。本节的第一个例子对应于之前被广泛应用的扩散过程的概率路径。由于直接求解概率路径，我们不需要对扩散过程进行推理。本节的第二个例子将基于Wasserstein-2最优传输解生成一个概率路径。

**例子一：扩散条件向量场** 扩散模型从原始数据开始逐渐增加噪声，直到接近一个纯噪声。这可以被形式化为一个随机过程，为了在任意时间t获得闭式表达，对这个过程有严格的约束条件，最终生成的高斯条件概率路径\(p_{t}(x | x_{1})\) 对于均值 \(\mu_{t}(x_{1})\) 和标准差\(\sigma_{t}(x_{1})\)有特定的选择 (Sohl-Dickstein et al., 2015; Ho et al., 2020; Song et al., 2020b)。例如，从噪声还原回数据的反向方差爆炸（VE）路径有以下形式：

\[p_{t}(x)=\mathcal{N}\left(x | x_{1}, \sigma_{1-t}^{2} I\right), \tag{16}\]

其中\(\sigma_{t}\) 是一个单调递增的函数, \(\sigma_{0}=0\) , \(\sigma_{1} \gg 1\) . 在（16）中均值和方差设定成以下形式\(\mu_{t}(x_{1})=x_{1}\) ，\(\sigma_{t}(x_{1})=\sigma_{1-t}\) ，这说明均值是一个与时间无关的函数，而方差是一个与真实数据无关的函数。将这些信息代入到（15），可以得到：

\[u_{t}\left(x | x_{1}\right)=-\frac{\sigma_{1-t}'}{\sigma_{1-t}}\left(x-x_{1}\right)  \tag{17}.\]

证明：均值与时间无关，对时间的导数为0。

与上述反向方差爆炸（VE）相对的，另一种反向传播方式，即反向方差保持（VP）扩散路径有以下形式：

\[p_{t}\left(x | x_{1}\right)=\mathcal{N}\left(x | \alpha_{1-t} x_{1},\left(1-\alpha_{1-t}^{2}\right) I\right),\\ \text{其中} \alpha_{t}=e^{-\frac{1}{2} T(t)}, T(t)=\int_{0}^{t} \beta(s) d s, \tag{18}\]

其中\(\beta\) 是噪声调度函数。（18）设定的均值和方差分别是\(\mu_{t}(x_{1})=\alpha_{1-t} x_{1}\)，\(\sigma_{t}(x_{1})=\sqrt{1-\alpha_{1-t}^{2}}\)。再次将这些表达式代入（15），得到：

$$
\begin{aligned}
u_{t}\left(x | x_{1}\right)
&=\frac{\alpha_{1-t}'}{1-\alpha_{1-t}^{2}}\left(\alpha_{1-t} x-x_{1}\right)\\
&=-\frac{T'(1-t)}{2}\left[\frac{e^{-T(1-t)} x-e^{-\frac{1}{2} T(1-t)} x_{1}}{1-e^{-T(1-t)}}\right] . \tag{19}
\end{aligned}$$

证明：
用链式法则求导

$$
\begin{aligned}
\alpha_{1-t}'&=(e^{-\frac{1}{2} T(1-t)})'\\
&= e^{-\frac{1}{2} T(1-t)}\ast (-\frac{1}{2} T(1-t))' \\
&= e^{-\frac{1}{2} T(1-t)}\ast (-\frac{1}{2}) \ast (T(1-t))'\\
&= \frac{1}{2}T'(1-t)e^{-\frac{1}{2} T(1-t)}
\end{aligned}$$

代入均值和标准差中求导
$$\begin{aligned}
\mu_{t}'(x_{1})&=\alpha_{1-t}' x_{1}\\
&= \frac{1}{2} x_{1} T'(1-t)e^{-\frac{1}{2} T(1-t)}
\end{aligned}$$

$$\begin{aligned}
\sigma_{t}'(x_{1})&=(\sqrt{1-\alpha_{1-t}^{2}})'\\
&= \frac{1}{2} (1-\alpha_{1-t}^{2})^{-\frac{1}{2}} \ast (1-\alpha_{1-t}^{2})'\\
&= \frac{1}{2} (1-\alpha_{1-t}^{2})^{-\frac{1}{2}} \ast (-2\alpha_{1-t})\ast\alpha_{1-t}'\\
&= -\alpha_{1-t}(1-\alpha_{1-t}^{2})^{-\frac{1}{2}}\ast\frac{1}{2}T'(1-t)e^{-\frac{1}{2} T(1-t)}\\
&= -\frac{e^{-\frac{1}{2} T(1-t)}}{2 \sqrt{1-e^{- T(1-t)}}}T'(1-t) e^{-\frac{1}{2} T(1-t)}\\
&= -\frac{e^{- T(1-t)}}{2 \sqrt{1-e^{- T(1-t)}}}T'(1-t)
\end{aligned}$$

将以上结果代入（15）
$$\begin{aligned}
u_{t}\left(x | x_{1}\right)&=\frac{\sigma_{t}'\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)}\left(x-\mu_{t}\left(x_{1}\right)\right)+\mu_{t}'\left(x_{1}\right)\\
&= \frac{-\frac{e^{- T(1-t)}}{2 \sqrt{1-e^{- T(1-t)}}}T'(1-t)}{\sqrt{1-\alpha_{1-t}^{2}}} \ast (x - \alpha_{1-t} x_{1}) + \frac{1}{2} x_{1} T'(1-t)e^{-\frac{1}{2} T(1-t)}\\
&= [-\frac{e^{- T(1-t)}}{2 (1-e^{- T(1-t)})}\ast (x - e^{-\frac{1}{2} T(1-t)} x_{1}) +\frac{1}{2} x_{1} e^{-\frac{1}{2} T(1-t)}] \ast T'(1-t)\\
&= -\frac{e^{- T(1-t)}x-e^{- \frac{1}{2} T(1-t)} x_1}{2 (1-e^{- T(1-t)})}T'(1-t)
\end{aligned}$$

证毕。

这个条件向量场与确定性概率流中先前使用的向量场（Song 等人，2020b，方程 13）是一致的。而且，通过将扩散条件向量场与流匹配目标相结合，可以为现有的分数匹配方法提供一种更加稳定和稳健的训练替代方案。

另一个重要的发现是，因为这些概率路径之前是从扩散过程得出的解，它们没有在有限时间中得到真正的噪声分布。在实践中，\(p_{0}(x)\)是通过一个高斯分布近似得到的，不是真正的标准正态分布。与之前的方法相比，本文提出的向量场可以完全控制概率路径，我们可以直接设定均值\(\mu_{t}\)和方差\(\sigma_{t}\)。

**例子二：最优传输条件向量场** 对于条件概率路径，有一个更加符合直觉的选择，即均值和标准差随着时间线性改变，即

\[\mu_{t}(x)=t x_{1}, \sigma_{t}(x)=1-\left(1-\sigma_{min }\right) t. \tag{20}\]

根据定理3的（15）式，条件向量场的形式为：

\[u_{t}\left(x | x_{1}\right)=\frac{x_{1}-\left(1-\sigma_{min }\right) x}{1-\left(1-\sigma_{min }\right) t},\tag{21}\]

证明：
$$\begin{aligned}
u_{t}\left(x | x_{1}\right)&=\frac{\sigma_{t}'\left(x_{1}\right)}{\sigma_{t}\left(x_{1}\right)}\left(x-\mu_{t}\left(x_{1}\right)\right)+\mu_{t}'\left(x_{1}\right)\\
&= \frac{-\left(1-\sigma_{min }\right)}{1-\left(1-\sigma_{min }\right) t}\ast (x - t x_{1}) + x_1\\
&= \frac{-\left(1-\sigma_{min }\right)x +  \left(1-\sigma_{min }\right)t x_1 + x_1 -\left(1-\sigma_{min }\right) t x_1}{1-\left(1-\sigma_{min }\right) t}\\
&= \frac{-\left(1-\sigma_{min }\right)x  + x_1 }{1-\left(1-\sigma_{min }\right) t}
\end{aligned}$$

证毕。

与（19）的扩散概率向量场对比，（21）的向量场中时间定义域为 \(t \in[0,1]\)，（19）不能达到\(t = 1\)，否则方差为0。对应于（21）的条件流形式如下：

\[\psi_{t}(x)=\left(1-\left(1-\sigma_{min }\right) t\right) x+t x_{1},\tag{22}\]

对应于（21）的CFM损失函数形式如下：

\[\mathcal{L}_{CFM}(\theta)=\mathbb{E}_{t, q\left(x_{1}\right), p\left(x_{0}\right)}\left\| v_{t}\left(\psi_{t}\left(x_{0}\right)\right)-\left(x_{1}-\left(1-\sigma_{min }\right) x_{0}\right)\right\| ^{2} . \tag{23}\]

证明：
回忆式（14）：
\[\mathcal{L}_{CFM}(\theta)=\mathbb{E}_{t, q\left(x_{1}\right), p\left(x_{0}\right)}\left\| v_{t}\left(\psi_{t}\left(x_{0}\right)\right)-\frac{d}{d t} \psi_{t}\left(x_{0}\right)\right\| ^{2} . \tag{14}\]

将（22）求导后代入即可证明。

使用线性改变的均值和标准差不知导出了简单且符合直觉的概率路径，而且也在以下多种意义上得到了最优解。条件流\(\psi_{t}(x)\)是两个高斯分布\(p_{0}(x | x_{1})\)和\(p_{1}(x | x_{1})\)之间的最优传输位移映射（OT displacement map）。最优传输插值(OT interpolant)是一种概率路径，McCann (1997)定义如下：

\[[(1-t) id+t \psi]_{*} p_{0} \tag{24}\]

其中 \(\psi: \mathbb{R}^{d} \to \mathbb{R}^{d}\) 是\(p_{0}\) 到\(p_{1}\) 的最优传输映射。记id 为恒等映射（identity map）,即\(id(x)=x\)。\((1-t) id+t \psi\)是最优传输位移映射。McCann (1997)证明过，在两个高斯分布之间，第一个分布是标准正态分布时，最优传输位移映射正是（22）中的形式。

补充：
虽然这段话中对最优传输映射\(\psi\)没有明确的数学表达式，不过通过改写（22），不难得到\(\psi\)的闭合形式。

$$\begin{aligned}
(1-t) x +t \psi &= \psi_{t}(x)\\
&= \left(1-\left(1-\sigma_{min }\right) t\right) x+t x_{1}\\
&= (1-t)x + t ( x_1 + \sigma_{min} x)
\end{aligned}$$

即
$$\psi = x_1 + \sigma_{min} x$$

直观地说，在最优传输（OT）位移映射下，粒子始终沿直线轨迹匀速运动。OT 向量场在时间上具有恒定的方向，这无疑使得回归任务更简单。

最后需要说明的是，尽管条件流是最优的，但这不意味着边际向量场是最优传输解。边际向量场的计算和特性决定了它与最优传输解存在差异。即使每个条件向量场对应的条件流是基于最优传输理论构建的，在聚合为边际向量场时，这种最优性无法直接传递。因为边际化操作会受到数据分布的影响，不同样本的条件向量场在聚合过程中相互作用，导致边际向量场难以满足最优传输解的严格定义。从直观上理解，就像不同的最优路径在综合考虑所有情况后，整体的路径不一定再是最优传输意义上的路径了。不过，我们认为边际向量场仍会相对简单。