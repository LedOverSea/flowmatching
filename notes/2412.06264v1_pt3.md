# 5. 非欧几里得流匹配

本节将流匹配从欧几里得空间\(\mathbb{R}^{d}\)扩展到一般的黎曼流形。通俗地说，黎曼流形是局部表现得像欧几里得空间的空间，并配备了广义的距离和角度概念。黎曼流形可用于建模各种类型的数据。例如，地球上自然现象的概率可以在球体上建模（Mathieu和Nickel，2020），而蛋白质骨架通常用矩阵李群来参数化（Jumper等人，2021）。流到黎曼流形的扩展归功于Mathieu和Nickel（2020）、Lou等人（2020）。然而，他们最初的训练算法需要昂贵的常微分方程模拟。借鉴Chen和Lipman（2024）的方法，本节中的流匹配解决方案提供了一种可扩展、无需模拟的训练算法，用于在黎曼流形上学习生成模型。

## 5.1 黎曼流形
我们考虑具有度量\(g\)的完备连通光滑黎曼流形M。点\(x \in M\)处的切空间（一个包含M在x处所有切向量的向量空间）记为\(T_{x} M\)。黎曼度量g在\(T_{x} M\)上定义了一个内积，对于u、\(v \in T_{x} M\)，该内积记为\(< u, v>_{g}\)。设\(T M=\cup_{x \in M}{x} ×T_{x} M\)为收集流形所有切平面的切丛。在下文，定义在切空间上的向量场是构建具有速度场的流形上的流的重要对象。我们用\(U={u_{t}}\)表示依赖于时间的光滑向量场（VFs）\(u_{t}:[0,1] ×M \to T M\)的空间，其中对于所有\(x \in M\)，都有\(u_{t}(x) \in T_{x} M\)。此外，\(div_{g}(u_{t})\)是关于空间（\((x)\)）变量的黎曼散度。最后，我们用\(dvol_{x}\)表示M上的体积元，函数\(f: M \to \mathbb{R}\)在M上的积分记为\(\int f(x) dvol_{x}\)。

## 5.2 流形上的概率、流和速度
流形M上的概率密度函数是连续的非负函数\(p: M \to \mathbb{R}_{≥0}\)，其积分值为1，即JM \(\int_{M} p(x) dvol_{x}=1\)。我们将时间\(p_{t}\)中的概率路径定义为概率空间P中的一个含时曲线，即\(p_{t}:[0,1] \to P\)。与欧几里得空间类似，含时流\(\psi:[0,1] ×M \to M\)对每一个t都在M上定义了一个全局微分同胚。

值得注意的是，通过速度场构建基于流的模型自然适用于一般的黎曼流形。形式上，改写自Mathieu和Nickel（2020）的命题1：  

**定理8**（流的局部存在性和唯一性）。设M是一个光滑完备流形，\(u_{t} \in U\)是一个速度场。如果u是\(C^{\infty}([0,1] ×M, T M)\)（特别是局部利普希茨的），那么式（3.19）中的常微分方程有唯一解，该解是一个定义在开集\(\Omega \supset{0} ×M\)上的\(C^{\infty}(\Omega, M)\)微分同胚\(\psi_{t}(x)\)。

与定理1类似，流ODE通常仅在流形上定义局部微分同胚，这意味着对于\(x \in M\)的不同值，\(\psi_{t}(x)\)可能在时间\([0, t_{x}])\)的最大区间上定义。与欧几里得情形类似，我们将使用半开时间区间\(t \in[0,1)\)，以允许q具有紧支集（对于这种情况，\(u_{t}\)并非处处有定义）。为确保在期望的时间区间[0,1)上存在解，我们添加了可积性约束（见定理2），并再次依赖质量守恒定理。对于具有度量\(g\)的黎曼流形，黎曼连续性方程为

\[\frac{d}{d t} p_{t}(x)+div_{g}\left(p_{t} u_{t}\right)(x)=0,\tag{5.1}\]

相应的流形质量守恒定理（Villani等人，2009年）表述如下。


**定理9**（流形质量守恒）。设\(p_{t}\)为一概率路径，\(u_{t} \in U\)为具有度量\(g\)的黎曼流形上的局部利普希茨可积向量场。则以下表述等价
1. 连续性方程（5.1）适用于\(t \in[0,1)\)。
2. 从3.24的意义上看，\(u_{t}\)生成了\(p_{t}\)。

在之前的结果中，可积的u指的是

\[\int_{0}^{1} \int_{\mathcal{M}}\left\| u_{t}(x)\right\| p_{t}(x) dvol_{x} d t<\infty .\tag{5.2}\]

请注意，定理9的假设在M上产生了一个全局微分同胚，从而得到了黎曼瞬时变量变换公式：

\[\frac{d}{d t} log p_{t}\left(\psi_{t}(x)\right)=-div_{g}\left(u_{t}\right)\left(\psi_{t}(x)\right) . \tag{5.3}\]

最后，如果
\[X_{t}=\psi_{t}\left(X_{0}\right) \sim p_{t} for X_{0} \sim p . \tag{5.4}\]
，我们称\(u_{t}\)从p生成\(p_{t}\)。

既然已将流定位为流形上有效的生成模型，那么流匹配（FM）原理也能迁移到该领域就顺理成章了。在流匹配的黎曼版本中，我们旨在找到一个速度场\(u_{t}^{\theta} \in U\)，以生成具有边际约束\(p_{0}=p\)和\(p_{1}=q\)的目标概率路径\(p_{t}:[0,1] \to P\)，其中p、q表示流形M上的源分布和目标分布。由于速度场位于流形的切空间上，黎曼流匹配损失使用在流形各个切平面上定义的布雷格曼散度来比较速度，
\[\mathcal{L}_{RFM}(\theta)=\mathbb{E}_{t, X_{t} \sim p_{t}} D_{X_{t}}\left(u_{t}\left(X_{t}\right), u_{t}^{\theta}\left(X_{t}\right)\right) . \tag{5.5}\]

在上面的方程中，期望现在是流形上的积分，即\(E[f(X)]=\int_{M} f(x) p_{X}(x) dvol_{x}\)，其中涉及光滑函数\(f: M \to M\)和随机变量\(X \sim p_{X}\)。Bregman散度，即\(D_{x}\)、\(x \in M\)，可能是通过黎曼内积以及分配给每个切空间\(\Phi_{x}: T_{x} M \to T_{x} M\)的严格凸函数来定义的，也就是\(D_{x}(u, v):=\Phi_{x}(u)-[\Phi_{x}(v)+< u-v, \nabla_{v} \Phi_{x}(v)>_{g}]\)。例如，选择黎曼度量\(\Phi_{x}=\|\cdot\|_{g}^{2}\)，那么对于e而言，\(D_{x}(u, v)=\|u-v\|_{g}^{2}\)，即\(v \in T_{x} M\)。

## 5.3 流形上的概率路径
边缘概率路径的构建方式与欧几里得情形（4.4）相同：

\[p_{t}(x)=\int_{\mathcal{M}} p_{t}\left(x | x_{1}\right) q\left(x_{1}\right) dvol_{x_{1}}, \tag{5.6}\]

其中\(p_{t | 1}(x | x_{1})\)是定义在流形上的条件概率路径。我们还需要边界约束

\[p_{0}=p, p_{1}=q .  \tag{5.7}\]

例如，这些约束可以通过要求条件路径\(p_{t | 1}(x | x_{1})\)满足
\[p_{0 | 1}\left(x | x_{1}\right)=\pi_{0 | 1}\left(x | x_{1}\right) , and p_{1 | 1}\left(x | x_{1}\right)=\delta_{x_{1}}(x), \tag{5.8}\]
来实现，其中\(\pi_{0 | 1}\)是条件耦合，\(\pi_{0 | 1}(x_{0} | x_{1})=\pi_{0,1}(x_{0}, x_{1}) / q(x_{1})\)。

## 5.4 流形的边缘化技巧
边际速度场的边缘化技巧（定理3）很容易应用于黎曼情形。考虑条件速度场\(u_{t}(x | x_{1}) \in U\)，使得

\[u_{t}\left(\cdot | x_{1}\right) \text{生成} p_{t | 1}\left(\cdot | x_{1}\right). \tag{5.9}\]

然后，边际速度场\(u_{t}(x)\)由条件速度的以下平均值给出，

\[u_{t}(x)=\int_{\mathcal{M}} u_{t}\left(x | x_{1}\right) p_{1 | t}\left(x_{1} | x\right) dvol_{x_{1}}, \tag{5.10}\]其中，根据概率密度函数的贝叶斯法则，我们得到

\[p_{1 | t}\left(x_{1} | x\right)=\frac{p_{t | 1}\left(x | x_{1}\right) q\left(x_{1}\right)}{p_{t}(x)}, \tag{5.11}\]

其定义适用于所有满足\(p_{t}(x)>0\)的\(x \in M\)

黎曼情形下的边缘化技巧（定理3）需要对假设1做如下调整：

**假设2**. \(p_{t | 1}(x | x_{1})\)是\(C^{\infty}([0,1) ×M)\)，且\(u_{t}(x | x_{1})\)是\(C^{\infty}([0,1) ×M, M)\)，它们均为\((t, x)\)的函数。此外，我们假设要么q具有有界支集，即在某个有界集外\(q(x_{1})=0\)，要么M是紧集；并且对于所有的\(x \in M\)和\(t \in[0,1)\)，都有\(p_{t}(x)>0\)。

我们现在可以陈述流形边缘化技巧定理：

**定理10**（流形边缘化技巧）。在假设2下，如果\(u_{t}(x | x_{1})\)是条件可积的，并且生成条件概率路径\(p_{t}(\cdot | x_{1})\)，那么边际速度场\(u_{t}(\cdot)\)会生成边际概率路径\(p_{t}(\cdot)\)。

所谓条件可积，我们指的是质量守恒定理（5.2）中可积性条件的条件版本：

\[\int_{0}^{1} \int_{\mathcal{M}} \int_{\mathcal{M}}\left\| u_{t}\left(x | x_{1}\right)\right\| _{g} p_{t | 1}\left(x | x_{1}\right) q\left(x_{1}\right) dvol_{x_{1}} dvol_{x} d t<\infty \tag{5.12}\]

## 5.5 黎曼流匹配损失
黎曼条件流匹配（RCFM）损失表示为

\[\mathcal{L}_{RCFM}(\theta)=\mathbb{E}_{t, X_{1}, X_{t} \sim p_{t | 1}\left(\cdot | X_{1}\right)} D_{X_{t}}\left(u_{t}\left(X_{t} | X_{1}\right), u_{t}^{\theta}\left(X_{t}\right)\right) . \tag{5.13}\]

我们再次得到等价关系：

**定理11**. 黎曼流匹配损失和黎曼条件流匹配损失的梯度一致：

\[\nabla_{\theta} \mathcal{L}_{R F M}(\theta)=\nabla_{\theta} \mathcal{L}_{R C F M}(\theta) . \tag{5.14}\]

上述定理可以利用命题1以及\(X=X_{t}\)、\(Y=u_{t}(X_{t} | X_{1})\)、\(g^{\theta}(x)=u_{t}^{\theta}(x)\)来证明，并对\(t \in[0,1]\)进行积分。

## 5.6 通过预度量的条件流
在确立了如何利用RCFM损失来学习流模型后，我们还需要明确条件概率路径及其生成速度场。与4.6节类似，我们首先阐述相应条件流\(\psi:[0,1) ×M ×M \to M\)的要求，以便\(p_{t | 1}(\cdot | x_{1})\)满足边界条件（5.8）。条件流模型为
\[X_{t | 1}=\psi_{t}\left(X_{0} | x_{1}\right), where X_{0} \sim \pi_{0 | 1}\left(\cdot | x_{1}\right), \tag{5.15}\]
，其中条件流为：
\[\psi_{t}\left(x | x_{1}\right)=\left\{\begin{array}{ll} x & t=0 \\ x_{1} & t=1 \end{array},\right. 在t、x上光滑，且在\mathcal{M}上关于x是微分同胚。\tag{5.16}\]

我们在欧几里得空间中的分析聚焦于仿射条件流，因为这类流形不仅性质丰富，且属于易于计算（无需模拟）的条件流范畴。遗憾的是，当\(\alpha_{t}+\sigma_{t} \neq1\)时，组合形式\(\alpha_{t} x_{1}+\sigma_{t} x_{0}\)无法在流形上自然定义。而当\(\alpha_{t}+\sigma_{t}=1\)时，流形上的对应形式可通过测地线插值实现。事实上，Chen与Lipman（2024）已提出通过沿测地线曲线移动来构建条件流的方法，该方法尤其推广了欧几里得空间中沿直线移动的条件最优传输（OT）路径（参见定理5）。测地线代表流形上两点间的最短路径，在欧几里得空间中会退化为直线。

对于流形，我们将测地线条件流定义为：
\[
\psi_{t}\left(x_{0} | x_{1}\right)=\exp _{x_{0}}\left(\kappa(t) \log _{x_{0}}\left(x_{1}\right)\right),\quad t \in[0,1] \tag{5.17}
\]

其中，\(\kappa(t):[0,1] \to [0,1]\)是一个单调递增的调度函数，满足\(\kappa(0)=0\)且\(\kappa(1)=1\)，这一设定可确保在\(t=1\)时所有\(x_{0}\)均被映射至\(x_{1}\)。

指数映射（在\(x \in M\)处取值）\(\exp _{x}: T_{x} M \to M\)（即\(v \mapsto \exp _{x}(v)\)）的几何意义为：给定流形\(M\)上一点\(x\)及该点切空间\(T_{x}M\)中的向量\(v\)，其结果是从\(x\)出发、以\(v\)为初始速度的唯一测地线在\(t=1\)时刻到达的端点。

对数映射\(\log _{x}: M \to T_{x} M\)（即\(y \mapsto \log _{x}(y)\)）是指数映射的逆映射：对于流形\(M\)上两点\(x\)与\(y\)，它将\(y\)映射到\(x\)的切空间\(T_{x}M\)中，得到的向量恰好是指数映射能从\(x\)生成\(y\)的“初始速度向量”。

在欧几里得空间中，指数映射退化为简单的向量加法，对数映射则退化为向量减法。此时，若将上述映射代入式（5.17），可得\(\psi_{t}(x_{0} | x_{1})=x_{0}+\kappa(t)(x_{1}-x_{0})\)；当选取\(\kappa(t)=t\)时，即可恢复条件最优传输（OT）流。

对于具有闭式指数映射和对数映射的简单流形，这种构造为流形上的训练流提供了一种无需模拟的方法，与基于流形的扩散模型方法（De Bortoli等人，2022；Huang等人，2022b；Lou等人，2023）相比，这无疑是一个明显的优势。特别是，流形扩散模型需要在训练中进行模拟，以便从\(p_{t}\)中采样，并且不得不依赖于流形上得分函数的近似。

然而，尽管构建测地线条件流是一种自然的构造，但对于那些没有闭式指数映射和对数映射的一般流形，测地线可能难以计算，并且/或者会引入不期望的偏差，例如将概率集中在边界点上。为了克服测地线计算中的困难并且/或者注入期望的隐含偏差，人们可以寻求一种替代的平滑距离函数概念（\(d(\cdot, \cdot): M ×M \to \mathbb{R}_{≥0}\)），并要求条件流满足
\[d\left(\psi_{t}\left(x_{0} | x_{1}\right), x_{1}\right)=\overline{\kappa}(t) d\left(x_{0}, x_{1}\right), \tag{5.18}\]

，其中\(\bar{\kappa}(t)=1-\kappa(t)\)。如果满足以下条件，这将确保条件流在时间\(t=1\)将所有概率集中在\(x_{1}\)处：

1. 非负：对于所有x，\(d(x, y) ≥0\)，\(y \in M\)
2. 阳性：\(d(x, y)=0\) 当且仅当 \(x=y\)
3. 非退化：\(\nabla d(x, y) ≠0\) 当且仅当 \(x ≠y\)

Chen和Lipman（2024）表明，对应于满足（5.18）的流的最小范数条件速度场具有以下形式：

\[u_{t}\left(x | x_{1}\right)=\frac{d log \overline{\kappa}(t)}{d t} d\left(x, x_{1}\right) \frac{\nabla d\left(x, x_{1}\right)}{\left\| \nabla d\left(x, x_{1}\right)\right\| _{g}^{2}},\tag{5.19}\]

其中，预度量的非退化要求确保速度场没有不连续性，因为\(u_{t}(x | x_{1}) \propto 1 /\left\|\nabla d(x, x_{1})\right\|_{q}\)。特别要注意的是，（5.17）中的测地线条件流在选择\(d=d_{g}\)时满足（5.18），其中\(d_{g}\)是测地线距离。另一种预度量选择的例子是在一般几何结构上使用谱距离（Chen和Lipman，2024），其中条件速度提供了一种通过模拟从\(p_{t}(x | x_{1})\)中采样的方法。重要的是，尽管带有预度量的条件流需要训练中的模拟（如流形上的扩散模型），但与得分函数的近似值相比，速度场仍然可以被准确恢复。

另一个问题是，通过测地线插值和预度量定义的条件流都可能存在奇点，例如在紧致流形上。例如，在二维球面上，测地线函数\(d(x, x_{1})\)在对径点\(x=-x_{1}\)处不可微。此外，任何光滑函数（如\(x \mapsto d(x, x_{1})\)）至少会有两个临界点（最大值点和最小值点），在这些点处，式（5.19）中的速度是未定义的。然而，这类问题点的集合通常非常小（实际上通常体积为零）。因此，至少在我们已知的用例中，这个问题在实际应用中不会造成麻烦。

无论如何，为了解决这个问题，我们可以在测地线条件流中加入一个增强调度器。也就是说，使用\(\bar{\kappa}(t, x, x_{1})\)，它还依赖于\(x\)、\(x_{1}\)，以使（5.17）具有全局光滑性。为了解决预度量条件流的零梯度问题，我们可以按如下方式放宽非退化要求：

3. 非退化（松弛）：对于所有\(y \in M\)，集合\(A_{y}=\{x \in M | \nabla d(x, y)=0\}\)和\(x ≠y\)的体积均为0。

# 6. 连续时间马尔可夫链模型
本节介绍连续时间马尔可夫链（CTMCs）作为流的替代生成模型，其应用场景是生成离散数据，即存在于离散（且有限）状态空间中的数据。连续时间马尔可夫链是马尔可夫过程，是离散流匹配（DFM）生成模型范式的基础构建块（Campbell等人，2024；Gat等人，2024），这将在第7节中进一步讨论。因此，本节与第3节类似，在第3节中，我们介绍了流作为流匹配（FM）生成模型范式的基础构建块。

## 6.1 离散状态空间和随机变量
考虑\(\mathbb{R}^{d}\)的有限版本作为我们的状态空间\(S=T^{d}\)，其中\(T=[K]={1,2, ..., K}\)，有时被称为词汇表。样本和状态用\(x=(x^{1}, ..., x^{d}) \in S\)表示，其中\(x^{i} \in T\)是单个坐标或一个标记。我们将类似地使用状态\(y, z \in S\)。接下来，X表示一个在状态空间s中取值的随机变量，其概率由概率质量函数（PMF）\(p_{X}: S \to \mathbb{R}_{≥0}\)控制，使得\(\sum_{x \in S} p_{X}(x)=1\)，且事件\(A \subset S\)的概率为
\[\mathbb{P}(X \in A)=\sum_{x \in A} p_{X}(x) . \tag{6.1}\]

标识符\(X \sim p_{X}\)或\(X \sim p_{X}(X)\)表明X具有概率质量函数\(p_{X}\)。离散情况下的δ概率质量函数定义为

\[\delta(x, z)= \begin{cases}1 & x=z, \\ 0 & else. \end{cases}\]

其中，我们有时也在标记上定义δ概率质量函数，例如在\(\delta(x^{i}, y^{i})\)中，对于某些\(x^{i}\)、\(y^{i} \in T\)

## 6.2 连续时间马尔可夫链生成模型

连续时间马尔可夫链（CTMC）模型是取值于状态空间\(S\)、依赖于时间的随机变量族\((X_t)_{0 \leq t \leq 1}\)，该随机变量族构成马尔可夫链，其特征由转移概率核\(p_{t+h|t}\)刻画，此转移概率核通过（下述方式/公式）定义：

\[
p_{t+h|t}(y|x) := \mathbb{P}(X_{t+h} = y \mid X_t = x) = \delta(y, x) + h u_t(y, x) + o(h), \quad \\\text{且} \quad \mathbb{P}(X_0 = x) = p(x), \tag{6.3}
\]

其中，概率质量函数（PMF）\(p\)表示过程在时刻\(t=0\)的初始分布；\(o(h)\)为任意函数，满足当\(t \to 0\)时\(\frac{o(h)}{h} \to 0\)。

\(u_t(y, x)\)的值被称为速率（rates）或速度（velocities），它作为时间的函数，描述了概率在不同状态间转移的速度。

此处“完全刻画（fully characterized）”的含义是：对于任意满足\(0 \leq t_1 < \dots < t_n \leq 1\)的时刻及任意状态\(x_i \in S\)（\(i \in [n]\)），所有联合概率\(\mathbb{P}(X_{t_1}=x_1, \dots, X_{t_n}=x_n)\)均通过该方式定义。

为确保转移概率\(p_{t+h | t}(y | x)\)通过式（6.3）定义，速度需要满足以下速率条件：

\[u_{t}(y, x) \geq 0 for all y \neq x , and \sum_{y} u_{t}(y, x)=0 . \tag{6.4}\]

如果这些条件中有一个不满足，那么对于任意小的\(h>0\)，转移概率\(p_{t+h | t}(\cdot | x)\)将变为负数或总和为\(c ≠1\)。在我们定义流生成建模时，式（6.3）与式（3.16）和式（3.19）起着相同的作用。过程\(X_{t}\)的边际概率在时间\(t \in[0,1]\)由概率质量函数\(p_{t}(x)\)表示。然后，类似于流情况下的式（3.24），我们说，

\[如果存在满足式（6.3）且具有边际p_{t}的p_{t+h | t}，那么一u_{t}生成p_{t}。\tag{6.5}\]

模拟CTMC。要采样\(x_{t}\)，应该先采样\(X_{0} \sim p\)并使用（简单的）欧拉方法执行步骤：

\[\mathbb{P}\left(X_{t+h}=y | X_{t}\right)=\delta\left(y, X_{t}\right)+h u_{t}\left(y, X_{t}\right) . \tag{6.6}\]

根据式（6.3），这些步骤会给更新概率引入\(o(h)\)误差。实际上，这意味着我们需要一个足够小的\(h>0\)，以确保式（6.6）右侧仍是有效的概率质量函数（PMF）。有一种可行的修正方法可以保证，无论\(h>0\)如何选择，结果都是有效的概率质量函数，且能维持概率中的\(o(h)\)局部误差，即以下欧拉方法：

\[
\mathbb{P}\big(X_{t+h} = y \mid X_t\big) = 
\begin{cases} 
\exp\big[h u_t(X_t, X_t)\big] &  y = X_t, \\
\frac{u_t(y, X_t)}{\lvert u_t(X_t, X_t) \rvert} \Big(1 - \exp\big[h u_t(X_t, X_t)\big]\Big) &  y \neq X_t 
\end{cases}
\tag{6.7}
\]

## 6.3 概率路径与柯尔莫哥洛夫方程
与连续情形下的连续性方程类似，连续时间马尔可夫链（CTMC）模型\((X_t)_{0 \leq t \leq 1}\)的边缘概率\(p_t\)由科尔莫戈罗夫方程刻画：

\[
\frac{d}{dt} p_t(y) = \sum_{x} u_t(y, x) p_t(x) \tag{6.8}
\]

下面的经典定理（另见Coddington等人（1956年）的定理5.1和5.2）描述了这个线性齐次常微分方程组的唯一解的存在性。

**定理12**（线性常微分方程的存在性与唯一性）。若\(u_{t}(y, x)\)属于\(C([0,1))\)（关于时间连续），则对于\(t \in[0,1)\)，存在柯尔莫哥洛夫方程（6.8）的唯一解\(p_{t}(x)\)，且满足\(p_{0}(x)=p(x)\)。

对于连续时间马尔可夫链（CTMC），其解在所有时间\(t \in[0,1)\)都保证存在，且不需要额外条件（与定理1中的非线性情况不同）。科尔莫戈罗夫方程与连续性方程（3.25）有着密切的联系。借助速率条件对（6.8）式的右侧进行重新整理，得到

\[\begin{aligned} \sum_{x} u_{t}(y, x) p_{t}(x) & \stackrel{(6.4)}{=} \overbrace{\sum_{x \neq y} u_{t}(y, x) p_{t}(x)}^{incoming flux }-\overbrace{\sum_{x \neq y} u_{t}(x, y) p_{t}(y)}^{outgoing flux } \\ & =-\sum_{x \neq y}\left[j_{t}(x, y)-j_{t}(y, x)\right] \end{aligned}\]

其中，\(j_{t}(y, x):=u_{t}(y, x) p_{t}(x)\)是概率通量，描述单位时间内从状态x转移到状态y的概率。出射通量的超额部分被定义为散度，这使得科尔莫戈罗夫方程具有与3.5节中所描述的连续性方程相同的结构（Gat等人，2024）。

以下结果是在连续时间马尔可夫链框架中构建概率路径和速度的主要工具：

**定理13**（离散质量守恒）。设\(u_{t}(y, x)\)属于\(C([0,1))\)，且\(p_{t}(x)\)是时间t内\(C^{1}([0,1))\) 1中的一个概率质量函数。那么，以下表述等价：

1. \(p_{t}\)、\(u_{t}\)满足\(t \in[0,1)\)的科尔莫戈罗夫方程（6.8），且\(u_{t}\)满足速率条件（6.4）。
2. \(u_{t}\) 生成 \(p_{t}\)，其意义针对 \(t \in[0,1)\) 为 6.5。

### 6.3.1 保概率速度
由于离散质量守恒（定理13），如果速度\(u_{t}(y, x)\)生成概率路径\(p_{t}(x)\)，那么

\[\tilde{u}_{t}(y, x)=u_{t}(y, x)+v_{t}(y, x) generates p_{t}(x), \tag{6.9}\]

只要\(v_{t}(y, x)\)满足速率条件（6.4）并求解无散度速度方程

\[\sum_{x} v_{t}(y, x) p_{t}(x)=0 . \tag{6.10}\]

实际上，\(\tilde{u}_{t}(y, x)\) 解了柯尔莫哥洛夫方程：

\[\sum_{x} \tilde{u}_{t}(y, x) p_{t}(x)=\sum_{x} u_{t}(y, x) p_{t}(x)=\dot{p}_{t}(y),\]

这表明在采样过程中可以添加无散度速度，而不会改变边际概率。这一点在接下来要介绍的从离散流匹配模型中采样时会是一个有用的事实。

# 7. 离散流匹配
值得注意的是，图2中的流匹配蓝图从连续情况无缝过渡到离散情况，形成了离散流匹配（DFM）框架（Campbell等人，2024；Gat等人，2024）。与连续情况类似，首先定义一个概率路径\(p_{t}\)，在源概率质量函数p和目标概率质量函数q之间进行插值。其次，我们希望找到一个连续时间马尔可夫链模型\((X_{t})_{0 ≤t ≤1}\)，该模型由可学习的速度\(u_{t}^{\theta}\)定义，用于生成概率路径\(p_{t}\)。最后，我们通过最小化定义离散流匹配损失的布雷格曼散度来训练\(u_{t}^{\theta}\)。总之，这是为了解决流匹配问题的离散版本（4.1）。

## 7.1 数据与耦合
我们的目标是将服从源概率质量函数（PMF）\(p\)的样本\(X_0 \sim p\)，转化为服从目标概率质量函数\(q\)的样本\(X_1 \in q\)，其中\(X_0\)与\(X_1\)均为取值于状态空间\(S\)的随机变量（RV）。

源样本与目标样本的关联方式有两种：一是通过独立耦合（independent coupling），即\((X_0, X_1) \sim p(X_0)q(X_1)\)；二是通过一般的概率质量函数耦合\(\pi_{0,1}(x_0, x_1)\)建立关联。

例如，在文本翻译数据中，考虑的是耦合数据\((x_0, x_1)\)，其代表同一文档的两种不同语言版本；而在文本生成等其他应用场景中，则涉及独立配对：此时\(p(x_0)\)既可以是状态空间\(S\)上的均匀概率（即所有状态的概率相等），也可以是在词汇表\(T\)中加入一个特殊标记\(m\)（即\(T \cup \{m\}\)），并令\(\pi_{0,1}(x_0, x_1) = \delta(x_0, m)q(x_1)\)。任意服从\(X_0 \sim \delta(X_0, m)\)的随机变量，均为常数随机变量\(X_0 = (m, \dots, m)\)。

## 7.2 离散概率路径
FM方案的下一步，和往常一样，是指定一条概率路径\(p_{t}\)来插值p和q。根据第4.4节，我们将这些对象基于一个一般的条件随机变量\(Z ~ p_{Z}\)进行条件设定，该随机变量取值于某个任意空间z。边际概率路径的形式为

\[p_{t}(x)=\sum_{z \in \mathcal{Z}} p_{t | Z}(x | z) p_{Z}(z), \tag{7.1}\]

其中\(p_{t | Z}(\cdot | z)\)是一个条件概率质量函数，且边际概率路径满足边界约束\(p_{0}=p\)和\(p_{1}=q\)。

## 7.3 边缘化技巧
边缘化技巧（参见4.4节）可直接应用于离散情况（Campbell等人，2024；Gat等人，2024）。假设条件速度场\(u_{t}(\cdot, \cdot | z)\)按照式（6.5）的意义生成\(p_{t}(\cdot | z)\)，我们得到边缘速度场
\[u_{t}(y, x)=\sum_{z} u_{t}(y, x | z) p_{Z | t}(z | x)=\mathbb{E}\left[u_{t}\left(y, X_{t} | Z\right) | X_{t}=x\right],\tag{7.2}\]

为所有\(x, y \in S\)定义，其中\(p_{t}(x)>0\)，且随机变量 \(X_{t} \sim p_{t | Z}(\cdot | Z)\)。通过使用贝叶斯法则，我们得到
\[p_{Z | t}(z | x)=\frac{p_{t | Z}(x | z) p_{Z}(z)}{p_{t}(x)} .\tag{7.3}\]

为证明边缘化技巧定理（定理3）的离散版本，假设：
假设3. \(p_{t | Z}(x | z) \in C^{1}([0,1))\)、\(u_{t}(y, x | z) \in C([0,1))\)和\(p_{t}(x)>0\)适用于所有\(x \in S\)和\(t \in[0,1)\)

正如在连续情况下所发生的那样，假设\(p_{t}>0\)在实际中是温和的，因为我们总是可以使用\((1-(1-t) \epsilon) \cdot p_{Z | t}+(1-t) \epsilon \cdot p_{uni }\)，其中\(p_{uni }\)是在s上的均匀分布，而\(\epsilon>0\)是任意小的。我们现在可以陈述并证明这个结果了。

定理14（离散边缘化技巧）。在假设3下，如果\(u_{t}(y, x | z)\)生成\(p_{t | Z}(x | z)\)，那么（7.2）中的边际速度\(u_{t}(y, x)\)会为\(t \in[0,1)\)生成（7.1）中的\(p_{t}(x)\)。

证明。该证明在概念上与连续情况类似。首先计算：

\[\begin{aligned} \frac{d}{d t} p_{t}(y) & =\sum_{z} \frac{d}{d t} p_{t | Z}(y | z) p_{Z}(z) \\ & \stackrel{(i)}{=} \sum_{z}\left[\sum_{x} u_{t}(y, x | z) p_{t | Z}(x | z)\right] p_{Z}(z) \\ & \stackrel{(i i)}{=} \sum_{x}\left[\sum_{z} u_{t}(y, x | z) \frac{p_{t | Z}(x | z) p_{Z}(z)}{p_{t}(x)}\right] p_{t}(x) \\ & \stackrel{( Bayes )}{=} \sum_{x} \overbrace{\sum_{z} u_{t}(y, x | z) p_{Z | t}(z | x)}^{u_{t}(y, x)} p_{t}(x), \end{aligned}\]

等式（i）由定理13以及\(u_{t}(y, x | z)\)生成\(p_{t | Z}(y | z)\)这一事实得出。等式（ii）通过乘以并除以\(p_{t}(x)\)得出，其中假设\(p_{t}(x)\)为正数。因此，\(u_{t}(y, x)\)满足带有\(p_{t}\)的柯尔莫哥洛夫方程。此外，\(u_{t}(y, x)\)满足速率条件（6.4），因为每个\(u_{t}(y, x | z)\)都满足这些条件。最后，\(u_{t}(y, x) \in C([0,1))\)，因为\(u_{t}(y, x | z)\)和\(p_{Z | t}(z | x)\)都在\(C([0,1))\)中。特别地，\(p_{Z | t}(z | x) \in C([0,1))\)由对\(t \in[0,1)\)假设\(p_{t}(x)>0\)得出。根据定理13，且由于\(u_{t}(x, y)\)满足带有\(p_{t}\)的柯尔莫哥洛夫方程和速率条件，它在（6.5）的意义下生成\(p_{t}\)。■


## 7.4 离散流匹配损失
为了构建一个CTMC生成模型\((X_{t})_{0 ≤t ≤1}\)，我们用参数θ对速度场\(u_{t}^{\theta}(y, x)\)进行参数化，例如使用神经网络。我们可以构建神经网络以满足速率条件方程（6.4）。用于训练CTMC模型的离散流匹配损失定义为：

\[\mathcal{L}_{DFM}(\theta)=\mathbb{E}_{t, X_{t} \sim p_{t}} D_{X_{t}}\left(u_{t}\left(\cdot, X_{t}\right), u_{t}^{\theta}\left(\cdot, X_{t}\right)\right), \tag{7.4}\]

其中\(t ~ U[0,1]\)和\(u_{t}(\cdot, x) \in \mathbb{R}^{S}\)满足速率条件。这意味着\(u_{t}(\cdot, x) \in \Omega_{x}\)，其中

\[\Omega_{x}=\left\{v \in \mathbb{R}^{S} | v(y) \geq 0 \forall y \neq x, and v(x)=-\sum_{y \neq x} v(y)\right\} \subset \mathbb{R}^{S}, \tag{7.5}\]

是一个凸集，而\(D_{x}(u, v)\)是使用凸函数\(\Phi_{x}: \Omega_{x} \to \mathbb{R}\)定义的布雷格曼散度。条件离散流匹配损失的形式为

\[\mathcal{L}_{CDFM}(\theta)=\mathbb{E}_{t, Z, X_{t} \sim p_{t | Z}} D_{X_{t}}\left(u_{t}\left(\cdot, X_{t} | Z\right), u_{t}^{\theta}\left(\cdot, X_{t}\right)\right) . \tag{7.6}\]

再次，这两个损失（7.4）和（7.6）都提供了相同的学习梯度。

**定理15**. 离散流匹配损失和条件离散流匹配损失的梯度一致：
\[\nabla_{\theta} \mathcal{L}_{D F M}(\theta)=\nabla_{\theta} \mathcal{L}_{C D F M}(\theta) . (7.7)\]

特别是，条件离散匹配损失的极小值是边缘速度
\[u_{t}^{\theta}(y, x)=\mathbb{E}\left[u_{t}\left(y, X_{t} | Z\right) | X_{t}=x\right] . (7.8)\]

证明可通过如下方式得到：应用命题1，其中设置\(X=X_{t}\)、\(Y=(X_{t}, Z)\)，将\(f: S^{2} \to \mathbb{R}^{S}\)定义为\((x, z) \mapsto u_{t}(\cdot, x | z) \in \mathbb{R}^{S}\)，并对\(t \in[0,1]\)进行积分。

## 7.5 因式分解路径与速度
如果按照所提出的方式实施DFM，我们将需要一个可学习模型\(u_{t}^{\theta}(y, x)\)——例如，一个神经网络——它能为所有可能的状态\(y \in S=T^{d}\)输出一个速率。这将导致巨大的输出维度\(K^{d}\)，对于常见的序列长度d和词汇量大小K来说是不可行的。解决这个问题的一个办法是考虑因子化速度（Campbell等人，2022），

\[u_{t}(y, x)=\sum_{i} \delta\left(y^{\overline{i}}, x^{\overline{i}}\right) u_{t}^{i}\left(y^{i}, x\right),\tag{7.9}\]

其中\(\bar{i}=(1, ..., i-1, i+1, ..., d)\)表示除i之外的所有索引。因此，上述因子化速度仅在状态x和状态y至多有一个标记不同的情况下，才将它们联系起来。使用因子化速度时，我们只需要对\(u_{t}^{i}(y^{i}, x)\)进行建模，因为它们能完全定义\(u_{t}(y, x)\)。相应地，每个\(u_{t}^{i}(y^{i}, x)\)都是一个可学习模型，它接收\(x \in S\)并返回一个标量\(u_{t}^{i}(y^{i}, x) \in \mathbb{R}\)，适用于所有\(i \in[d]={1,2, ..., d}\)和\(y^{i} \in T\)。因此，该模型的输出具有可处理的维度\(d \cdot K\)。现在，因子化速度\(u_{t}^{i}(y, x)\)的速率条件需要按维度\(i \in[d]\)来确定：

\[u_{t}^{i}\left(y^{i}, x\right) \geq 0 for all y^{i} \neq x^{i} , and \sum_{y^{i} \in \mathcal{T}} u_{t}^{i}\left(y^{i}, x\right)=0 for all x \in \mathcal{S} . \tag{7.10}\]

### 7.5.1 用因式分解速度模拟连续时间马尔可夫链
使用因子化速度时，我们可以按坐标对CTMC模型进行采样（Campbell等人，2024）：

\[\begin{aligned} \mathbb{P}\left(X_{t+h}=y | X_{t}=x\right) & =\delta(y, x)+h \sum_{i} \delta\left(y^{\overline{i}}, x^{\overline{i}}\right) u_{t}^{i}\left(y^{i}, x\right)+o(h) \\ & =\prod_{i}\left[\delta\left(y^{i}, x^{i}\right)+h u_{t}^{i}\left(y^{i}, x\right)+o(h)\right], \end{aligned}\]

其中第二个等式由\(\delta(y, x)=\prod_{i} \delta(y^{i}, x^{i})\)和恒等式i ai + hbi = i ai + h得出

\[\prod_{i}\left[a^{i}+h b^{i}\right]=\prod_{i} a^{i}+h \sum_{i}\left(\prod_{j \neq i} a^{j}\right) b^{i}+o(h) .\]

因此，在\(o(h)\)阶范围内，转移核可分解为坐标独立的转移

\[\mathbb{P}\left(X_{t+h}^{i}=y^{i} | X_{t}=x\right)=\delta\left(y^{i}, x^{i}\right)+h u^{i}\left(y^{i}, x\right)+o(h) .\tag{7.11}\]

这些可以通过每个坐标的欧拉方法（6.7）进行采样。有趣的是，连续流匹配也具有类似的因子分解\(u_{t}(x)=[u_{t}^{1}(x), ..., u_{t}^{d}(x)] \in \mathbb{R}^{d}\)，其中\(\dot{X}_{t}^{i}(x)=u_{t}^{i}(X_{t})\)决定了坐标i的变化，并且可以独立采样（连续流匹配中的“样本”只是确定性的）。

### 7.5.2 用因式分解速度构建概率路径
如果我们以某种方式构建概率路径，结果会发现通过这种构建方式得到了因式分解的速度（式（7.9））。接下来我们将解释这种构建方法。为此，我们将因式分解的概率路径定义为具有以下形式的概率路径：

\[q_{t}(x)=\prod_{i} q_{t}^{i}\left(x^{i}\right) . \tag{7.12}\]

那么，以下结果表明这些因式分解的概率路径具有因式分解的速度。

命题2. 设\(q_{t}(x)\)是式（7.12）中的因式分解概率路径，其中\(u_{t}^{i}(y^{i}, x^{i}) \in C([0,1))\)生成\(q_{t}^{i}(x^{i})\)。则\(q_{t}\)具有如下形式的因式分解生成速度：

\[u_{t}(y, x)=\sum_{i} \delta\left(y^{\overline{i}}, x^{\overline{i}}\right) u_{t}^{i}\left(y^{i}, x^{i}\right) . \tag{7.13}\]

为了进行证明，让我们将概率质量函数\(q(x)\)的边缘分布记为
\[q^{i}\left(x^{i}\right):=\sum_{x^{i}} q(x) q^{\overline{i}}\left(x^{\overline{i}}\right):=\sum_{x^{i}} q(x) \tag{7.14}\]

证明：设\(q_{t}\)是一个因式分解的概率路径（7.12）。设\(u_{t}^{i}(y^{i}, x^{i})\)是\(q_{t}^{i}(x^{i})\)的生成速度。对t求导可得

\[\begin{aligned} \frac{d}{d t} q_{t}(y) & =\sum_{i} q_{t}^{\overline{i}}\left(y^{\overline{i}}\right) \frac{d}{d t} q_{t}^{i}\left(y^{i}\right) \\ & \stackrel{(i)}{=} \sum_{i}\left[\sum_{x^{\overline{i}}} \delta\left(y^{\overline{i}}, x^{\overline{i}}\right) q_{t}^{\overline{i}}\left(x^{\overline{i}}\right)\right]\left[\sum_{x^{i}} u_{t}^{i}\left(y^{i}, x^{i}\right) q_{t}^{i}\left(x^{i}\right)\right] \\ & \stackrel{(i i)}{=} \sum_{x}\left[\sum_{i} \delta\left(y^{\overline{i}}, x^{\overline{i}}\right) u_{t}^{i}\left(y^{i}, x^{i}\right)\right] q_{t}(x), \end{aligned}\]  

等式（i）由\(q_{t}^{\bar{i}}(y^{\bar{i}})=\sum_{x^{\bar{i}}} \delta(y^{\bar{i}}, x^{\bar{i}}) q_{t}^{\bar{i}}(x^{\bar{i}})\)和柯尔莫哥洛夫方程（6.8）得出。等式（ii）通过改变求和顺序并注意到，根据\(q_{t}\)的定义，我们有\(q_{t}^{\bar{i}}(x^{\bar{i}}) q_{t}^{i}(x^{i})=q_{t}(x)\)，以及\(\sum_{x^{\overline{i}}} \sum_{x^{i}}=\sum_{x}\). ■

我们现在准备展示构建路径\(p_{t}\)的主要工具，这些路径具有因式分解的速度，能够在任意p和q之间进行插值（Campbell等人，2024；Gat等人，2024）。

**定理16**（离散因式分解边缘化技巧）。考虑通过
\[p_{t}(x)=\sum_{z} p_{t | Z}(x | z) p_{Z}(z), with p_{t | Z}(x | z)=\prod_{i} p_{t | Z}^{i}\left(x^{i} | z\right), \tag{7.15}\]
构建的边际概率路径，即条件路径在式（7.12）意义下可因式分解的情况。进一步假设，\(u_{t}^{i}(y^{i}, x^{i} | z)\) i是\(C([0,1))\)在\(C^{1}([0,1))\)中生成\(p_{t | Z}^{i}(x^{i} | z)\)，且对于所有\(x \in S\)和\(t \in[0,1)\)，都有\(p_{t}(x)>0\)。那么，边际速度为
\[u_{t}(y, x)=\sum_{i} \delta\left(y^{\overline{i}}, x^{\overline{i}}\right) u_{t}^{i}\left(y^{i}, x\right) \tag{7.16}\]
，其中
\[u_{t}^{i}\left(y^{i}, x\right)=\sum_{z} u_{t}^{i}\left(y^{i}, x^{i} | z\right) p_{Z | t}(z | x)=\mathbb{E}\left[u_{t}^{i}\left(y^{i}, X_{t}^{i} | Z\right) | X_{t}=x\right] \tag{7.17}\]
生成\(p_{t}(x)\)。

证明：根据命题2，分解的条件路径\(p_{t | Z}(x | z)\)具有分解的生成速度\(u_{t}(y, x | z)=\sum_{i} \delta(y^{\bar{i}}, x^{\bar{i}}) u_{t}^{i}(y^{i}, x^{i} | z)\)。因此，

\[\begin{aligned} u_{t}(y, x) & \stackrel{(i)}{=} \sum_{z} u_{t}(y, x | z) p_{Z | t}(z | x) \\ & \stackrel{(i i)}{=} \sum_{z}\left[\sum_{i} \delta\left(y^{\overline{i}}, x^{\overline{i}}\right) u_{t}^{i}\left(y^{i}, x^{i} | z\right)\right] p_{Z | t}(x | z) \\ & \stackrel{(i i i)}{=} \sum_{i} \delta\left(y^{\overline{i}}, x^{\overline{i}}\right)\left[\sum_{z} u_{t}^{i}\left(y^{i}, x^{i} | z\right) p_{Z | t}(z | x)\right] . \end{aligned}\]

等式（i）由（7.2）得出。等式（ii）由假设\(ptz\)具有因式分解速度得出。等式（iii）由改变求和顺序得出。因为\(p_{t | Z}^{i}(x^{i} | z) \in C^{1}([0,1))\)和\(p_{t}(x)>0\)，所以\(p_{t | Z}(x | z) \in C^{1}([0,1))\)。同样，因为\(u_{t}^{i}(y^{i}, x^{i} | z) \in C([0,1))\)，所以\(u_{t}(y, x | z) \in C([0,1))\)。因此，定理14表明，\(u_{t}(y, x)\)生成\(p_{t}(x)\)，这与要求一致。 ■

利用定理16，我们可以设计一条概率路径\(p_{t}\)，其具有因式分解的速度，可在源概率质量函数p和目标概率质量函数q之间进行插值，具体如下。

1. 找到因式分解的概率条件路径\(p_{t | Z}(x | z)=\prod_{i} p_{t | Z}^{i}(x^{i} | z)\)，使得边际\(p_{t}(x)\)满足\(p_{0}=p\)和\(p_{1}=q\)。

2. 找到生成速度\(u_{t}^{i}(y^{i}, x^{i} | z)\)到\(p_{t | Z}^{i}(x^{i} | z)\)。这可以通过找到科尔莫戈罗夫方程的解\(u_{t}^{i}(y^{i}, x^{i} | z)\)来完成：

\[\sum_{x^{i}} u_{t}^{i}\left(y^{i}, x^{i} | z\right) p_{t | Z}^{i}\left(x^{i} | z\right)=\frac{d}{d t} p_{t | Z}^{i}\left(y^{i} | z\right), \tag{7.18}\]

对于所有\(y^{i} \in T\)、\(i \in[d]\)、\(z \in Z\)和\(t \in[0,1)\)的固定值。需要说明的是，（7.18）是一个欠定线性方程组，具有\(|T|\)个未知数（远少于整个状态空间|S|的未知数数量）。

### 7.5.3 用于因子化速度的条件离散流匹配损失

用因式分解速度\(u_{t}^{\theta, i}\)表示边际速度\(u_{t}^{\theta}\)，可得到以下条件流匹配损失
\[\mathcal{L}_{CDFM}(\theta)=\mathbb{E}_{t, Z, X_{t} \sim p_{t | Z}} \sum_{i} D_{X_{t}}^{i}\left(u_{t}^{i}\left(\cdot, X_{t} | Z\right), u_{t}^{\theta, i}\left(\cdot, X_{t}\right)\right),\tag{7.19}\]

，其中\(t ~ U[0,1]\)，且\(u_{t}^{i}(\cdot, x | z)\)、\(u_{t}^{\theta, i}(\cdot, x) \in \mathbb{R}^{T}\)满足速率条件。这意味着\(u_{t}^{i}(\cdot, x | z)\)、\(u_{t}^{\theta, i}(\cdot, x) \in\)、\(\Omega_{x}\)，其中对于\(\alpha \in T\)，我们定义
\[\Omega_{\alpha}=\left\{v \in \mathbb{R}^{\mathcal{T}} | v(\beta) \geq 0 \forall \beta \in \mathcal{T} \backslash\{\alpha\}, and v(\alpha)=-\sum_{\beta \neq \alpha} v(\beta)\right\} \subset \mathbb{R}^{\mathcal{T}} . \tag{7.20}\]

这是一个凸集，\(D_{x}^{i}(u, v)\) 是由凸函数 \(\Phi_{x}^{i}: \Omega_{x^{i}} \to \mathbb{R}\) 定义的布雷格曼散度。和之前一样，我们利用命题 1 并设置 \(X=X_{t}\)、\(Y=u_{t}^{i}(\cdot, X_{t}, Z) \in \mathbb{R}^{T}\) 来证明这个损失的合理性，其中 \(D_{x}^{i}(u, v)\) 是 \(\Omega_{x^{i}} \subset \mathbb{R}^{T}\) 上的布雷格曼散度，并对 \(t \in[0,1]\) 进行积分。

### 7.5.4 混合路径
现在是时候实施7.5.2节，以构建实际的概率路径及其相应的条件速度了。根据Gat等人（2024年）的研究，我们以\(Z=(X_{0}, X_{1})\)为条件，以适应任意的数据耦合\((X_{0}, X_{1}) ~ \pi_{0,1}(X_{0}, X_{1})\)。然后，我们构建因式分解的条件路径
\[p_{t | 0,1}\left(x | x_{0}, x_{1}\right)=\prod_{i} p_{t | 0,1}^{i}\left(x^{i} | x_{0}, x_{1}\right) \tag{7.21}\]

作为混合

\[p_{t | 0,1}^{i}\left(x^{i} | x_{0}, x_{1}\right)=\kappa_{t} \delta\left(x^{i}, x_{1}^{i}\right)+\left(1-\kappa_{t}\right) \delta\left(x^{i}, x_{0}^{i}\right), (7.22)\]

其中\(\kappa:[0,1] \to [0,1]\)是一个\(C^{1}([0,1])\)调度器。注意，随机变量\(X_{t}^{i} ~ p_{t | 0,1}^{i}(\cdot | x_{0}, x_{1})\)遵循
\[X_{t}^{i}=\left\{\begin{array}{ll} x_{1}^{i} & 以概率 \kappa_{t} \\ x_{0}^{i} & 以概率 \left(1-\kappa_{t}\right) \end{array},\right. \tag{7.23}\]
即，它以取决于时间t的概率取源状态或目标状态。

若\(\kappa_0 = 0\)且\(\kappa_1 = 1\)，则（7.1）中的边缘概率\(p_t(x)\)满足边界约束。我们还需要为\(p^i_{t|0,1}(x_i|x_0, x_1)\)生成速度\(u^i_t(y_i, x_i|x_0, x_1)\)，这些速度是（7.18）的解。我们推导如下：

\[\begin{aligned} \frac{d}{d t} p_{t | Z}^{i}\left(y^{i} | z\right) & \stackrel{(7.22)}{=} \dot{\kappa}_{t}\left[\delta\left(y^{i}, x_{1}^{i}\right)-\delta\left(y^{i}, x_{0}^{i}\right)\right] \\ & \stackrel{(7.22)}{=} \dot{\kappa}_{t}\left[\delta\left(y^{i}, x_{1}^{i}\right)-\frac{p_{t | Z}^{i}\left(y^{i} | z\right)-\kappa_{t} \delta\left(y^{i}, x_{1}^{i}\right)}{1-\kappa_{t}}\right] \\ & =\frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\delta\left(y^{i}, x_{1}^{i}\right)-p_{t | Z}^{i}\left(y^{i} | z\right)\right] \\ & =\sum_{x^{i}} \frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\delta\left(y^{i}, x_{1}^{i}\right)-\delta\left(y^{i}, x^{i}\right)\right] p_{t | Z}^{i}\left(x^{i} | z\right), \end{aligned}\]

其中，为简洁起见，我们交替使用\(z = (x_0, x_1)\)和\(Z = (X_0, X_1)\)。综上，我们得到了生成（7.22）中路径的条件速度，即：

\[
u^i_t(y_i, x_i|x_0, x_1) = \frac{\dot{\kappa}_t}{1 - \kappa_t} \left[ \delta(y_i, x^i_1) - \delta(y_i, x_i) \right] \tag{7.24}
\]

**速度后验参数化**。与连续情况类似（例如，第4.8.1节），我们可以选择以不同方式参数化我们的速度\(u_{t}^{i}(y^{i}, x)\)。第一种方法是直接对其进行参数化，类似于流中的速度。我们在这里采用的另一种方法是受以下混合边际速度计算的启发（遵循式7.17）：

\[\begin{aligned} u_{t}^{i}\left(y^{i}, x\right) & =\sum_{x_{0}, x_{1}} \frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\delta\left(y^{i}, x_{1}^{i}\right)-\delta\left(y^{i}, x^{i}\right)\right] p_{0,1 | t}\left(x_{0}, x_{1} | x\right) \\ & =\sum_{x_{1}^{i}} \frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\delta\left(y^{i}, x_{1}^{i}\right)-\delta\left(y^{i}, x^{i}\right)\right] p_{1 | t}^{i}\left(x_{1}^{i} | x\right), \end{aligned} (7.25)\]

其中，对于第二个等式，我们表示后验\(p_{0,1 | t}\)的边际

\[
p^i_{1|t}(x^i_1|x) = \sum_{x_0, \bar{x}^i_1} p_{0,1|t}(x_0, x_1|x) \tag{7.26}
\]

\[
= \mathbb{E} \left[ \delta(x^i_1, X^i_1) \mid X_t = x \right] \tag{7.27}
\]

这个推导表示边际\(u_{t}^{i}(y^{i}, x)\)，使用可学习的后验\(p_{1 | t}^{\theta, i}(x_{1}^{i} | x)\)，这可以理解为\(x_{1}\)预测的离散版本（4.8.1节）。接下来，我们将探索用于学习这个后验的损失函数。

混合路径的CDFM损失 我们提出了两种学习\(p_{1 | t}^{\theta, i}(x_{1}^{i} | x)\)的方法，均由命题1证明。首先，边际后验（7.26）和（7.27）可以通过以下条件匹配损失来学习.

\[\mathcal{L}_{CM}(\theta)=\mathbb{E}_{t, X_{0}, X_{1}, X_{t}} D_{X_{t}}\left(\delta\left(\cdot, X_{1}^{i}\right), p_{1 | t}^{\theta, i}\left(\cdot | X_{t}\right)\right) \tag{7.28}\]

因为
\(\delta(\cdot, X_{1}^{i})\)起，\(p_{1 | t}^{\theta, i}(\cdot | X_{t})\)是PMF。因此，我们可以将布雷格曼散度设为KL散度。\(D(p, q)=\sum_{\alpha \in T} p(\alpha) log \frac{p(\alpha)}{q(\alpha)}\) 比较概率质量函数，获取

\[\mathcal{L}_{CM}(\theta)=-\mathbb{E}_{t, X_{0}, X_{1}, X_{t}} log p_{1 | t}^{\theta, i}\left(X_{1}^{i} | X_{t}\right)+ const. \tag{7.29}\]

或者，我们可以遵循7.5.3节，使用（7.19）中的因式分解损失，其中\(u_{t}^{\theta, i}\)由\(p_{1 | t}^{\theta, i}\)参数化。在这种情况下，我们可以将Bregman散度设置为比较一般（不一定是概率）向量\(u, v \in \mathbb{R}_{≥0}^{m}\)的广义KL散度。

\[D(u, v)=\sum_{j} u^{j} log \frac{u^{j}}{v^{j}}-\sum_{j} u_{j}+\sum_{j} v_{j} . \tag{7.30}\]

对于D的这种选择，我们得到

\[D\left(u_{t}^{i}\left(\cdot, x^{i} | x_{0}, x_{1}\right), u_{t}^{\theta, i}(\cdot, x)\right)=\frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\left(\delta\left(x_{1}^{i}, x^{i}\right)-1\right) log p_{1 | t}^{\theta, i}\left(x_{1}^{i} | x\right)+\delta\left(x_{1}^{i}, x^{i}\right)-p_{1 | t}^{\theta, i}\left(x^{i} | x\right)\right] \tag{7.31}\]

当以\(Z=(X_{0}, X_{1})\)为条件时，它实现了损失（7.19）。广义KL损失（7.31）也为目标分布的似然性提供了一个证据下界（ELBO）（Shaul等人，2024），

\[-log p_{1}^{\theta}\left(x_{1}\right) \leq \mathbb{E}_{t, X_{0}, X_{t} \sim p_{t | 0,1}} \sum_{i} D\left(u_{t}^{i}\left(\cdot, X_{t}^{i} | X_{0}, x_{1}\right), u_{t}^{\theta, i}\left(\cdot, X_{t}\right)\right),\tag{7.32}\]

其中\(p_{1}^{\theta}\)是模型在时间\(t=1\)生成的边际分布。因此，除了训练之外，广义KL损失还常用于评估。

**采样混合路径** 基于后验\(p_{1 | t}^{\theta, i}\)的参数化导致了以下采样算法.如7.5.1节所述，使用因式分解速度可以实现逐坐标采样（7.11）。根据（7.17）和（7.25），

\[\begin{aligned} \mathbb{P}\left(X_{t+h}^{i}=y^{i} | X_{t}=x\right) & =\delta\left(y^{i}, x^{i}\right)+h u^{i}\left(y^{i}, x\right)+o(h) & & (7.33) \\ & =\sum_{x_{1}^{i}}\left[\delta\left(y^{i}, x^{i}\right)+h \frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\delta\left(y^{i}, x_{1}^{i}\right)-\delta\left(y^{i}, x^{i}\right)\right]+o(h)\right] p_{1 | t}^{i}\left(x_{1}^{i} | x\right) . \tag{7.34}\end{aligned}\]

因此，鉴于\(X_{t}=x\)，我们可以通过执行接下来的两个步骤来完成一步采样。对于每个\(i \in[d]\)：（i）绘制\(X_{1}^{i} ~ p_{1 | t}^{i}(X_{1}^{i} | x)\)；以及（ii）根据（6.7）中的欧拉步骤，使用速度\(\frac{\dot{\kappa}_{t}}{1-\kappa_{t}}[\delta(y^{i}, X_{1}^{i})-\delta(y^{i}, x^{i})]\)更新\(X_{t+h}^{i}\)。直观地说，（ii）决定是设置\(X_{t+h}^{i}=X_{1}^{i}\)还是保持在\(X_{t+h}^{i}=X_{t}^{i}\)。

单边混合路径和保概率速度 如6.3.1节所述，通过添加一些无散度分量来扩展采样算法的设计空间通常是有用的。对于因子化路径，无散度速度\(v_{t}^{i}\)需要满足（7.18），即

\[\sum_{x^{i}} v_{t}^{i}\left(y^{i}, x^{i} | z\right) p_{t | Z}^{i}\left(x^{i} | z\right)=0 . (7.35)\]

一般来说，若不学习额外的量（例如\(p_{0 | t}^{i}\)），找到这种保持概率的速度可能具有挑战性。然而，在一种有用的情况下，可以找到闭合形式的保持概率的速度，即假设独立同分布的源分布（即\(p(x)=\prod_{i} p(x^{i})\)）和独立耦合（\(\pi_{0,1}(x_{0}, x_{1})=\)、\(p(x_{0}) q(x_{1})\)）。在这种情况下，边际混合路径具有以下形式：

\[p_{t}(x)=\sum_{x_{1}} p_{t | 1}\left(x | x_{1}\right) q\left(x_{1}\right), where p_{t | 1}\left(x | x_{1}\right)=\prod_{i} p_{t | 1}^{i}\left(x^{i} | x_{1}\right),\]

其中\(p_{t | 1}^{i}(x^{i} | x_{1})=[\kappa_{t} \delta(x^{i}, x_{1}^{i})+(1-\kappa_{t}) p(x^{i})]\)。式（7.24）中的条件速度，即

\[u_{t}^{i}\left(y^{i}, x^{i} | x_{1}\right)=\frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\delta\left(y^{i}, x_{1}^{i}\right)-\delta\left(y^{i}, x^{i}\right)\right] (7.36)\]

也会生成\(p_{t | 1}^{i}(x^{i} | x_{1})\)。例如，为了找到无散度速度，我们可以从该速度中减去一个用于\(p_{t | 1}^{i}(y^{i}, x^{i} | x_{1})\)的 backward-time 速度\(\bar{u}_{t}^{i}\)（Gat等人，2024），其意义是该速度满足带有\(p_{t | 1}^{i}(y^{i}, x^{i} | x_{1})\)的科尔莫戈罗夫方程，且\(-\tilde{u}_{t}^{i}\)满足速率条件。这种速度可以按照类似于式（7.24）的方式找到：

\[\overline{u}_{t}^{i}\left(y^{i}, x^{i} | x_{1}\right)=\frac{\dot{\kappa}_{t}}{\kappa_{t}}\left[\delta\left(y^{i}, x^{i}\right)-p\left(x^{i}\right)\right] . (7.37)\]

因此，可以通过
\[v_{t}^{i}\left(y^{i}, x^{i} | x_{1}\right)=u_{t}^{i}\left(y^{i}, x^{i} | x_{1}\right)-\tilde{u}_{t}^{i}\left(y^{i}, x^{i} | x_{1}\right) . (7.38)\]
来定义\(p_{t | 1}^{i}(x^{i} | x_{1})\)条件路径的无散度速度。

根据第6.3.1节，如果我们在速度\(u_{t}^{i}(y^{i}, x^{i} | x_{1})\)中添加一个无散度场\(v_{t}^{i}(y^{i}, x^{i} | x_{1})\)，后者仍然生成相同的概率路径\(p_{t | 1}^{i}(x^{i} | x_{1})\)。因此，定理16表明边缘速度\(u_{t}^{i}(y^{i}, x)\)由
\[\begin{aligned} u_{t}^{i}\left(y^{i}, x\right) & =\sum_{x_{1}}\left[u_{t}^{i}\left(y^{i}, x^{i} | x_{1}\right)+c_{t} v_{t}^{i}\left(y^{i}, x^{i} | x_{1}\right)\right] p_{1 | t}\left(x_{1} | x\right) \\ & =\sum_{x_{1}^{i}}\left[u_{t}^{i}\left(y^{i}, x^{i} | x_{1}^{i}\right)+c_{t} v_{t}^{i}\left(y^{i}, x^{i} | x_{1}^{i}\right)\right] p_{1 | t}^{i}\left(x^{i} | x\right), \end{aligned}\]
定义，仍生成相同的边际路径\(p_{t}(x)\)，其中第二个等式源自\(u_{t}^{i}(y^{i}, x^{i} | x_{1})=u_{t}^{i}(y^{i}, x^{i} | x_{1}^{i})\), 对于混合路径，以及\(v_{t}^{i}(y^{i}, x^{i} | x_{1}^{i})\) 都是如此。总之，考虑到 \(X_{t}=x\)，该过程的单步
广义抽样算法包括（i）绘制\(X_{1}^{i} ~ p_{1 | t}^{i}(X_{1}^{i} | x)\)和（ii）执行欧拉步（6.7）以速度

\[u_{t}^{i}\left(y^{i}, x^{i} | x_{1}\right)=\frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\delta\left(y^{i}, X_{1}^{i}\right)-\delta\left(y^{i}, x^{i}\right)\right]+c_{t}\left[\frac{\dot{\kappa}_{t}}{1-\kappa_{t}}\left[\delta\left(y^{i}, x_{1}^{i}\right)-\delta\left(y^{i}, x^{i}\right)\right]-\frac{\dot{\kappa}_{t}}{\kappa_{t}}\left[\delta\left(y^{i}, x^{i}\right)-p\left(x^{i}\right)\right]\right],\]

其中\(c_{t}>0\)是一个与时间相关的常数。








