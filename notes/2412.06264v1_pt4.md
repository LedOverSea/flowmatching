# 8. 连续时间马尔可夫过程模型
在前几节中，我们已经在\(\mathbb{R}^{d}\)和黎曼流形上开发了一个流模型（见第3节和第5节），并为离散数据开发了一个CTMC模型（见第6节）。在本节中，我们希望将这些模型统一并扩展为一个生成模型，该模型适用于（1）一般状态空间和（2）一般马尔可夫过程。这个生成模型将使我们能够在第9节中将流匹配的原理扩展到适用于多种模态的各种生成模型。

## 8.1 一般状态空间和随机变量
处理通用模态。我们的明确目标不是指定所使用的模态。因此，在本节中，令s为通用状态空间。重要的例子包括\(S=\mathbb{R}^{d}\)（例如，图像、向量）、s离散（例如，语言）、s为黎曼流形（例如，几何数据）或它们的乘积，用于联合生成多种数据模态（多模态模型）。对于所有模态，我们可以在s上定义一个度量（或距离函数）\(d: S ×S \to \mathbb{R}_{≥0}\)、\((x, y) \mapsto d(x, y)\)。例如，对于s离散，如果\(y ≠x\)且对于所有\(x \in S\)都有\(d(x, x)=0\)，那么该度量就是\(d(x, y)=1\)。对于\(S=\mathbb{R}^{d}\)，我们使用\(d(x, y)=\|x-y\|\)。我们需要做出一个技术假设，即\((S, d)\)是一个波兰度量空间，也就是说，它是完备的（即任何柯西序列都收敛）且可分的（即它有一个可数稠密子集）。机器学习中任何受关注的模态都具有这一性质。

一般状态空间上的密度。到目前为止，在这项工作中，我们假设状态s上的概率分布p由密度\(p: S \to \mathbb{R}_{≥0}\)表示。对于一般的状态空间，我们使用一般参考测度\(\nu\),密度变为拉东-尼科迪姆导数\(\frac{d p}{~d \nu}\)。换句话说，概率可以表示为关于v的积分

\[\mathbb{P}(A)=\int_{A} p(x) \nu(d x) 对所有可测的 A \subset \mathcal{S}\]

对于离散的情况，\(\nu\)是计数测度（因此积分只是求和），而\(p(x)\)只是概率质量函数（PMF）。对于\(S=\mathbb{R}^{d}\)，r是勒贝格测度（因此积分只是“通常的”积分），而\(p(x)\)只是概率密度函数（PDF）。上面的内容将其推广到了任意状态空间。

（可选）处理任意分布。需要注意的是，并非每个概率分布都存在关于参考测度的密度。对于不熟悉一般测度论的读者，可以将这种可能性作为技术性说明忽略不计，只要所处理的相关分布具有密度\(p(x)\)即可。然而，需要注意的是，这些并非只是病态示例，在机器学习应用中，存在一些实际相关的案例会涉及这一点：一个简单的例子是\(S=\mathbb{R}^{d}\)上形式为\(p_{t}=\delta_{(1-t) x+t y}\)的概率路径，它以直线连接两个点\(x\)、\(y \in \mathbb{R}^{d}\)——这无法用密度来表示。另一个例子是\(S=C([0,1], \mathbb{R})\)上的概率分布，例如在轨迹建模中，这些分布通常不存在关于公共参考测度的密度。为了从数学上处理这类情况，我们针对S上的一般概率测度p开发了我们的框架。为此，我们使用符号\(p(~d x)\)，其中“dx”是一个符号表达式，表示对变量x关于p的积分。例如，对于有界可测函数\(f: S \to \mathbb{R}\)，我们写出

\[\mathbb{E}_{X \sim p}[f(X)]=\int f(x) p( d x)\]

来表示勒贝格积分或f在p下的期望值。和之前一样，我们（稍作符号滥用）使用相同的符号\(p(x)\)来表示测度\(p(~d x)\)的密度。

## 8.2 CTMP生成模型
同样地，我们明确的目标是构建一个适用于任意演化过程的模型——无论我们使用流、扩散、连续时间马尔可夫链（CTMC）、它们的组合，还是其他方法。因此，在本节中，我们定义了一个具有一般性但满足构建生成模型所需正则性假设的演化过程。对于\(t \in[0,1]\)，设\(X_{t} \in S\)为一个随机变量。如果\((X_{t})_{0 ≤t ≤1}\)满足以下条件，我们就称其为连续时间马尔可夫过程（CTMP）：


\[\begin{array} {r}{\mathbb {P}[X_{t_{n+1}}\in A|X_{t_{1}},X_{t_{2}},... ,X_{t_{n}}]=\mathbb {P}[X_{t_{n+1}}\in A|X_{t_{n}}] (0\leq t_{1}<\cdots <t_{n+1}\leq 1,A\subseteq \mathcal {S})}\end{array} \tag{8.1}\]


通俗地说，上述条件表明该过程没有记忆性。如果我们知道现在的状态，那么了解过去并不会影响我们对未来的预测。在表2中，我们概述了几类重要的马尔可夫过程。例如，流形上的流是具有确定性转移的马尔可夫过程，扩散过程是具有由布朗运动驱动的转移的马尔可夫过程，而连续时间马尔可夫链（CTMCs）是由速率决定的马尔可夫过程（我们将在8.2.2节中详细解释这一点）。每个马尔可夫过程都有一个转移内核\((p_{t+h | t})_{0 ≤t<t+h ≤1}\)为每个\(x \in S\)分配一个概率分布\(p_{t+h | t}(\cdot | x)\)，以便

\[\mathbb{P}\left[X_{t+h} \in A | X_{t}=x\right]=p_{t+h | t}(A | x) \text{ for all } t, h \geq 0, A \subset \mathcal{S} 可测 (8.2)\] 

由于马尔可夫假设，马尔可夫过程由转移核和\(x_{0}\)的分布唯一确定。相反，任何转移核和初始分布都定义了一个马尔可夫过程。因此，存在一一对应的关系。

我们的下一个目标是为连续时间马尔可夫决策过程（CTMPs）定义一个相应的速度场泛化。通俗地说，它将是转移核在t中的一阶导数：

\[\mathcal{L}_{t}:=\left.\frac{d}{d h}\right|_{h=0} p_{t+h | t} (8.3)\]

我们将一阶导数\(L_{t}\)称为\(p_{t+h | t}\)的生成器（Ethier和Kurtz，2009；Rüschendorf等人，2016）。与导数类似，生成器是一阶线性近似，并且比\(p_{t+h | t}\)更容易参数化。正如我们将看到的，扩散模型、流模型和其他生成模型都可以被视为学习马尔可夫过程生成器的算法。这就得出了CTMP生成模型的一般形式，如下所示：

\[CTMP model (informal): p_{t+h | t}(\cdot | x):=\delta_{x}+h \mathcal{L}_{t}(x)+o(h) , and X_{0} \sim p . (8.4)\]

然而，由于转移核\(p_{t+h | t}\)并非真正的函数，方程8.3和8.4仅为启发式的，尚未有明确的定义。因此，本节的首要目标是给出生成器和连续时间马尔可夫过程生成模型的正式定义。

### 8.2.1 生成器的正式定义
式（8.3）中的第一个问题是，导数通常是针对映射到向量空间的函数来定义的, 但\(p_{t+h | t}\)映射到一个分布。不过，这可以通过使用测试函数来缓解。测试函数是“探测”概率分布的一种方式。它们作为一种理论工具，能像处理实值函数一样处理分布。具体来说，一组测试函数是有界可测函数\(f: S \to \mathbb{R}\)的族T，这些函数能完全表征概率分布，即对于s上的两个概率分布\(\mu_{1}\)、\(\mu_{2}\)，有
\[\mu_{1}=\mu_{2} \Leftrightarrow \mathbb{E}_{X \sim \mu_{1}}[f(X)]=\mathbb{E}_{X \sim \mu_{2}}[f(X)] for all f \in \mathcal{T} (8.5)\]
成立。

一般来说，人们会选择尽可能“好”（或规则）的T。例如，如果\(S=\mathbb{R}^{d}\)，那么具有紧支集的无穷可微函数空间\(T=C_{c}^{\infty}(\mathbb{R}^{d})\)就满足该性质。对于离散的s，\(T=\mathbb{R}^{S}\)仅由所有函数组成（在这种情况下，这些函数只是向量）。令\(X_{t} ~ p_{t}\)。我们将边际作用和转移作用定义为

\[\left< p_{t}, f\right>:=\int f(x) p_{t}( d x)=\mathbb{E}_{X \sim p_{t}}[f(X)]\tag{8.6}\]

\[\left< p_{t+h | t}, f\right>(x):=\left< p_{t+h | t}(\cdot | x), f\right>=\mathbb{E}\left[f\left(X_{t+h}\right) | X_{t}=x\right] \tag{8.7}\]

其中，边际作用将每个测试函数f映射到标量\(< p_{t}, f> \in \mathbb{R}\)，而转移作用将实值函数\(x \mapsto f(x)\)映射到另一个实值函数\(x \mapsto< p_{t+h | t}, f>\)（x）。塔式性质意味着\(< p_{t},< p_{t+h | t}, f>>=< p_{t+h}, f>\)。我们注意到，上述只是“象征性的”点积，但如果存在密度\(p_{t}(x)\)，即\(< p_{t}, f>=\int f(x) p_{t}(x) \nu(d x)\)，它就会成为“真正的”点积。

如式（8.3）那样正式定义导数的第二步是，我们需要对我们现在定义的马尔可夫过程施加某种“平滑性”概念。设\(C_{0}(S)\)为在无穷远处消失的连续函数\(f: S \to \mathbb{R}\)构成的空间，即对于所有\(\epsilon>0\)，存在紧集\(K \subset S\)，使得对于所有\(x \in S K\)，都有\(|f(x)|<\epsilon\)。我们在\(C_{0}(S)\)上使用上确界范数\(\|\cdot\|_{\infty}\)。如果连续时间马尔可夫过程\(X_{t}\)满足以下两个条件，则称为费勒过程（Feller, 1955；Rüschendorf等人, 2016）：
1. 强连续性：\(p_{t+h | t}\)的作用在时间上是连续的：

\[lim _{h' \to h, t' \to t}\left\| \left< p_{t'+h' | t'}, f\right>-\left< p_{t+h | t}, f\right>\right\| _{\infty}=0 for all h, t \geq 0, f \in C_{0}(\mathcal{S})\]

2. 无法从无穷远处返回：\(p_{t+h | t}\)的作用保持在无穷远处消失的函数：

\[\left< p_{t+h | t}, f\right> \in C_{0}(\mathcal{S}) for all h, t \geq 0, f \in C_{0}(\mathcal{S})\]

**假设4**. 连续时间马尔可夫过程\((X_{t})_{0 ≤t ≤1}\)是一个费勒过程。
考虑到我们希望在机器学习模型中使用\(X_{t}\)，这是一个合理的假设：我们定义了概率路径，其中生成过程\(X_{t}\)的分布平滑变化，并且我们所有的数据通常都位于某个有界（紧）集内。

现在让我们重新审视（8.3）并尝试定义\(p_{t+h | t}\)的导数。考虑到测试函数的视角，我们可以对\(< p_{t+h | t}, f>\)（2）求导，以\(x \in S\)为变量，并定义
\[\left.\frac{d}{d h}\right|_{h=0}\left< p_{t+h | t}, f\right>(x)=lim _{h \to 0} \frac{\left< p_{t+h | t}, f\right>(x)-f(x)}{h}:=\left[\mathcal{L}_{t} f\right](x) . (8.8)\]

我们将此操作称为生成器\(L_{t}\)，并为所有上述极限一致存在的f定义它，即在范数\(\|\cdot\|_{\infty}\)中。直观地说，生成器被定义为测试函数的算子。在表2中，有几个我们在8.2.2节中推导的生成器示例。生成器和费勒过程之间存在一一对应关系（Rogers和Williams，2000；Ethier和Kurtz，2009；Pazy，2012）——就像流和向量场之间存在对应关系一样（参见定理1）。这之后将使我们能够通过神经网络中的生成器来参数化费勒过程。

根据这一定义，式（8.4）中的CTMP模型具有现已明确的形式，即

\[\left.\left< p_{t+h | t}, f\right>=f+h \mathcal{L}_{t} f+o(h)( for all f \in \mathcal{T}\right) and X_{0} \sim p (8.9)\]

其中\(o(h)\)描述了一个误差项\(E(h) \in C_{0}(S)\)，使得\(\lim _{h \to 0} \frac{1}{h}\|E(h)\|_{\infty}=0\)。与流动情况下的式（3.24）以及CTMC情况下的式（6.5）类似，我们称\(L_{t}\)生成\(p_{t}\)，如果存在一个满足式（8.9）的\(p_{t+h | t}\)，且CTMP \(X_{t}\)满足\(X_{t} ~ p_{t}\)（8.10）。

换句话说，如果一个马尔可夫过程（1）用\(p=p_{0}\)初始化，且（2）用\(L_{t}\)进行模拟，其边缘分布为\(p_{t}\)，那么生成器\(c_{t}\)就会生成概率路径\(p_{t}\)。

### 8.2.2 CTMP模型示例

**流**。令\(S=\mathbb{R}^{d}\)和\(u:[0,1] ×\mathbb{R}^{d} \to \mathbb{R}^{d}\)、\((t, x) \mapsto u_{t}(x)\)为定义流\(\psi_{t}\)的时变速度场（见第3节）。令\(T=C_{c}^{\infty}(\mathbb{R}^{d})\)为具有紧支集的无穷可微光滑函数空间。那么我们可以通过
\[\begin{aligned} {\left[\mathcal{L}_{t} f\right](x) } & =lim _{h \to 0} \frac{\mathbb{E}\left[f\left(X_{t+h}\right) | X_{t}=x\right]-f(x)}{h} & &(8.11)\\ & \stackrel{(i)}{=} lim _{h \to 0} \frac{\mathbb{E}\left[f\left(X_{t}+h u_{t}\left(X_{t}\right)+o(h)\right) | X_{t}=x\right]-f(x)}{h} & & (8.12) \\ & \stackrel{(i i)}{=} lim _{h \to 0} \frac{\mathbb{E}\left[f\left(X_{t}\right)+h \nabla f\left(X_{t}\right)^{T} u_{t}\left(X_{t}\right)+o(h) | X_{t}=x\right]-f(x)}{h} & & (8.13) \\ & =lim _{h \to 0} \frac{f(x)+h \nabla f(x)^{T} u_{t}(x)+o(h)-f(x)}{h} & & (8.15) \\ & =\nabla f(x)^{T} u_{t}(x), & & (8.16) \end{aligned}\]
计算生成元，其中（i）来自流的欧拉近似，（ii）来自f在\(x_{t}\)附近的一阶泰勒近似。因此，流生成元由下式给出

\[\mathcal{L}_{t} f(x)=\nabla f(x)^{T} u_{t}(x) . (8.17)\]

**扩散**。令\(S=\mathbb{R}^{d}\)和σt：[0, 1]→RdRd×d，\((t, x) \mapsto \sigma_{t}(x)\)为一个以连续方式映射到对称半正定矩阵\(\sigma_{t}\)的时变函数。具有扩散系数\(\sigma_{t}\)的扩散过程通过维纳过程\(W_{t}\)的SDE \(d X_{t}=\sigma_{t}(X_{t}) d W_{t}\)来定义（Øksendal，2003）。该过程可通过无穷小采样程序近似：

\[X_{t+h}=X_{t}+\sqrt{h} \sigma_{t}\left(X_{t}\right) \epsilon_{t}, \epsilon_{t} \sim \mathcal{N}(0, I) \tag{8.18}\]

再次令\(T=C_{c}^{\infty}(\mathbb{R}^{d})\)成立。然后我们可以通过下式计算生成器

\[\begin{aligned} {\left[\mathcal{L}_{t} f\right](x) } & =lim _{h \to 0} \frac{\mathbb{E}\left[f\left(X_{t}+\sqrt{h} \sigma_{t}\left(X_{t}\right) \epsilon_{t}+o(h)\right) | X_{t}=x\right]-f(x)}{h} & (8.19)\\ 
& \stackrel{(i)}{=} lim _{h \to 0} \frac{\mathbb{E}_{\epsilon_{t}}\left[f(x)+\nabla f(x)^{T} \sqrt{h} \sigma_{t}(x) \epsilon_{t}+\frac{1}{2} h\left[\sigma_{t}(x) \epsilon_{t}\right]^{T} \nabla^{2} f(x)\left[\sigma_{t}(x) \epsilon_{t}\right]+o(h)-f(x)\right]}{h} & (8.20) \\ 
& =lim _{h \to 0} \frac{\nabla f(x)^{T} \sqrt{h} \sigma_{t}(x) \mathbb{E}_{\epsilon_{t}}\left[\epsilon_{t}\right]+\mathbb{E}_{\epsilon_{t}}\left[\frac{1}{2} h\left[\sigma_{t}(x) \epsilon_{t}\right]^{T} \nabla^{2} f(x)\left[\sigma_{t}(x) \epsilon_{t}\right]\right]}{h} & (8.21) \\ 
& =\frac{1}{2} \mathbb{E}_{\epsilon_{t}}\ [\epsilon_{t}^T [\sigma_{t}(x)]^T \nabla^2 f(x)[\sigma_{t}(x)] \epsilon_{t}] & (8.22)\\
& \stackrel{(i i)}{=} \frac{1}{2} tr\left(\sigma_{t}(x)^{T} \nabla^{2} f(x) \sigma_{t}(x)\right) & (8.23)\\
& \stackrel{(i i i) }{=} \frac{1}{2} tr\left(\sigma_{t}(x) \sigma_{t}(x)^{T} \nabla^{2} f(x)\right) & (8.24)\\
& \stackrel{(i v)}{=} \frac{1}{2} \sigma_{t}^{2}(x) \cdot \nabla^{2} f(x) (8.25)
\end{aligned}\]

其中在（i）中我们使用二阶泰勒近似（二阶是因为\(\mathbb{E}[\left\|\sqrt{h} \epsilon_{t}\right\|^{2}] \propto h)\)），在（ii）中，对于\(A \in \mathbb{R}^{d ×d}\)使用恒等式\(tr(A)=\mathbb{E}_{\epsilon_{t}}[\epsilon_{t}^{T} A \epsilon_{t}]\)，在（iii）中使用迹的循环性质，在（iv）中使用\(\sigma_{t}\)的对称性。此外，我们使用\(A \cdot B:=tr(A^{T} B)\)表示矩阵A、\(B \in \mathbb{R}^{d ×d}\)的矩阵内积。因此，扩散生成器由下式给出

\[\mathcal{L}_{t} f(x)=\frac{1}{2} \sigma_{t}^{2}(x) \cdot \nabla^{2} f(x) . (8.26)\]

**跳跃**。接下来，令s为任意值，我们来考虑一个跳跃过程。跳跃过程由一个依赖于时间的核\(Q_{t}(d y, x)\)定义，即对于每个\(0 ≤t ≤1\)和每个\(x \in S\)，\(Q_{t}(d y, x)\)是\(S \backslash \{x\}\)上的一个正测度。跳跃过程的思想是，分配给\(S {x}\)的总体积

\[\lambda _{t}(x)=\int Q_{t}(dy,x) (8.27)\]

给出了跳跃强度，即跳跃的无穷小似然。此外，如果\(\lambda_{t}(x)>0\)，我们可以通过将\(Q_{t}\)归一化为一个概率核来确定跳跃分布

\[J_{t}( d y, x)=\frac{Q_{t}( d y, x)}{\lambda_{t}(x)} . (8.28)\]

跳跃过程可以通过如下的无穷小抽样程序来近似：

\[X_{t+h}= \begin{cases}X_{t} & with probability 1-h \lambda_{t}\left(X_{t}\right)+o(h) \\ \sim J_{t}\left( d y, X_{t}\right) & with probability h \lambda_{t}\left(X_{t}\right)+o(h)\end{cases} (8.29)\]

关于跳跃过程的严格处理，例如可参见（Davis，1984）。此时，生成元由下式给出
\[\begin{aligned} \mathcal{L}_{t} f(x) & =lim _{h \to 0} \frac{\mathbb{E}\left[f\left(X_{t+h}\right)-f\left(X_{t}\right) | X_{t}=x\right]}{h} & (8.30) \\ 
& =lim _{h \to 0} \frac{\mathbb{E}\left[f\left(X_{t+h}\right)-f\left(X_{t}\right) | X_{t}=x, Jump in [t, t+h)\right] \mathbb{P}\left[ Jump in [t, t+h) | X_{t}=x\right]}{h} & (8.31) \\ 
& +lim _{h \to 0} \underbrace{\mathbb{E}\left[f\left(X_{t+h}\right)-f\left(X_{t}\right) | X_{t}=x, No jump in [t, t+h) | X_{t}=x\right]}_{=0} & (8.32) \\ 
& =lim _{h \to 0} \frac{\mathbb{E}_{Y \sim J_{t}( d y, x)}[f(Y)-f(x)] h \lambda_{t}(x)}{h} & (8.33) \\ 
& =\mathbb{E}_{Y \sim J_{t}( d y, x)}[f(Y)-f(x)] \lambda_{t}(x) & (x) & (8.34) \\
& = \int (f(y) - f(x)) Q_t(dy, x) & (8.35)\\
\end{aligned}\]

这里我们用到了：如果\(X_{t}\)没有在\([t, t+h]\)中跳转，那么\(X_{t+h}=X_{t}\)。因此，跳转生成器由下式给出.
\[\mathcal{L}_{t} f(x)=\int(f(y)-f(x)) Q_{t}( d y, x)=\lambda_{t}(x) \mathbb{E}_{Y \sim J_{t}( d y, x)}[f(Y)-f(x)] . (8.36)\]

**连续时间马尔可夫链（CTMC）**。让我们考虑一个在离散空间s上的连续时间马尔可夫链\(X_{t}\)，其具有\(|S|<\infty\)。实际上，这只是一个具有特定参数化的离散状态空间上的跳跃过程。为了理解这一点，考虑离散状态空间s上的一个普通跳跃核，它由矩阵\(Q_{t} \in \mathbb{R}_{≥0}^{S ×S}\)给出，并且利用方程（8.36），生成元由下式给出：

\[\mathcal{L}_{t} f(x)=\sum_{y \in \mathcal{S}}[f(y)-f(x)] Q_{t}(y, x)=\sum_{y \neq x}[f(y)-f(x)] Q_{t}(y, x) for all x \in \mathcal{S}, f \in \mathbb{R}^{\mathcal{S}}\]

即，\(Q_{t}(x, x)\)的值无关紧要且是不确定的。因此，一个自然的约定是通过速率对离散状态空间上的跳跃核进行重新参数化：

\[u_{t}(y, x)= \begin{cases}Q_{t}(y, x) & if y \neq x \\ -\sum_{z \neq x} Q_{t}(z ; x) & if y=x\end{cases}\]

通过这一点，我们恢复了第6节中的速率\(u_{t}(y, x)\)，通过构造满足6.4中的速率条件。因此，这表明离散空间上的跳跃模型与CTMC模型（第6节）一致。将其应用于方程（8.37），我们得到CTMC生成元由
\[\mathcal{L}_{t} f(x)=\sum_{y \in \mathcal{S}} f(y) u_{t}(y, x)=f^{T} u_{t} (8.38)\]
给出，其中我们将\(f=(f(x))_{x \in S}\)视为列向量，将\(u_{t} \in \mathbb{R}^{S ×S}\)视为矩阵。因此，生成元函数只是左侧的向量乘法。

**流形上的流**。接下来，我们如第5节所述考虑黎曼流形\(S=M\)上的流。流\(\psi:[0,1] ×M \to M\)是通过向量场\(u:[0,1] ×M \to T M\)借助（3.19）中的常微分方程来定义的。我们用\(\psi_{t | s}(x)=\psi_{t}(\psi_{s}^{-1}(x))\)表示从时间s到t的过渡（如（3.17）中所示）。那么，对于光滑函数\(f: M \to \mathbb{R}\)，黎曼流生成元由下式给出

\[\mathcal{L}_{t} f(x)=lim _{h \to 0} \frac{f\left(\psi_{t+h | t}(x)\right)-f(x)}{h}=\left<\nabla f(x),\left.\frac{d}{d h}\right|_{h=0} \psi_{t+h | t}(x)\right>_{g}=\left<\nabla f(x), u_{t}(x)\right>_{g} (8.39)\]

其中\(<\cdot, \cdot>_{g}\)描述了定义黎曼度量g的点积，\(\nabla f\)描述了f关于g的梯度。实际上，该生成元与函数的李导数（Jost，2008）一致，这是微分几何中的一个基本概念。

## 8.3 概率路径与科尔莫戈罗夫方程
对于\(S=\mathbb{R}^{d}\)上的流匹配，连续性方程（见3.25）是核心数学方程，它使我们能够构建产生期望概率路径的速度场（见3.5节）。在本节中，我们推导了一个适用于连续时间马尔可夫过程（CTMPs）的相应且更通用的方程。设\(x_{t}\)是具有生成元\(L_{t}\)的连续时间马尔可夫过程，且\(X_{t} ~ p_{t}\)，那么我们知道：

\[\frac{d}{d t}\left< p_{t}, f\right>=\left.\frac{d}{d h}\right|_{h=0}\left< p_{t+h}, f\right>=\left.\frac{d}{d h}\right|_{h=0}\left< p_{t},\left< p_{t+h | t}, f\right>\right>=\left< p_{t},\left.\frac{d}{d h}\right|_{h=0}\left< p_{t+h | t}, f\right>\right>=\left< p_{t}, \mathcal{L}_{t} f\right>\]

其中我们利用了\(< p_{t}, \cdot>\)运算的线性性质来交换导数，并且根据塔式性质\(< p_{t},< p_{t+h | t}, f>>=< p_{t+h}, f>\)。这表明，给定马尔可夫过程\(x_{t}\)的生成元\(C_{t}\)，我们可以通过其边际概率的无穷小变化来恢复这些边际概率，即我们得到了柯尔莫哥洛夫前向方程（KFE）。  


\[\frac{d}{d t}\left< p_{t}, f\right>=\left< p_{t}, \mathcal{L}_{t} f\right> for all f \in \mathcal{T} (8.40)\]

式（8.40）中的KFE版本决定了测试函数f的期望演化。如果我们使用没有密度的概率分布，这一点是必要的。如果存在密度，则可以使用更常见的KFE版本，该版本直接规定概率密度的变化。为了说明这一点，我们引入伴随生成元\(L_{t}^{*}\)，它作用于相对于参考测度ν的概率密度\(p_{t}(x)\)，即\(L_{t}^{*} p_{t}(x)\)由以下恒等式（隐式地）定义。
\[\int p_{t}(x) \mathcal{L}_{t} f(x) \nu(d x)=\int \mathcal{L}_{t}^{*} p_{t}(x) f(x) \nu(d x) \forall f \in \mathcal{T} (8.41)\]

此外，我们需要假设\(p_{t}\)在t中是可微的。现在，将（8.41）应用于KFE（8.40），我们得到
\[\begin{array}{rlrl} \int \frac{d}{d t} p_{t}(x) f(x) \nu(d x) & =\frac{d}{d t} \int p_{t}(x) f(x) \nu(d x) & & (8.42) \\ & =\frac{d}{d t}\left< p_{t}, f\right> & & (8.43) \\ & =\left< p_{t}, \mathcal{L}_{t} f\right> & & (8.44) \\ & =\int p_{t}(x) \mathcal{L}_{t} f(x) \nu(d x) & & (8.45) \\ & =\int \mathcal{L}_{t}^{*} p_{t}(x) f(x) \nu(d x) & & (8.46) \end{array}\]
由于这一点适用于所有测试函数f，我们可以利用方程（8.5）得出结论：这等价于伴随KFE

\[\frac{d}{d t} p_{t}(x)=\mathcal{L}_{t}^{*} p_{t}(x) for all x \in \mathcal{S} (8.47)\]

正如我们将在以下示例中推导的那样，伴随KFE推广了许多用于开发生成模型的著名方程，例如连续性方程或福克-普朗克方程（Song等人，2021；Lipman等人，2022）（见表2）。只要存在概率密度，我们就使用伴随KFE——以避免使用测试函数，而是直接处理概率密度。我们将在下文总结我们的发现。

**定理17**（广义质量守恒）。设\(c_{t}\)是\((X_{t})_{0 ≤t ≤1}\)的生成元。通俗地说，以下条件是等价的：
1. \(p_{t}\)、\(L_{t}\)满足KFE（8.40）。
2. \(\frac{d p_{t}}{~d \nu}(x)\)、\(L_{t}\)满足伴随KFE（8.47）。
3. 按照方程（8.10）的意义，\(L_{t}\)生成\(p_{t}\) (8.10)。

形式上，只要\(\frac{d p_{t}}{~d \nu}\)存在且在t中连续可微，（1）和（2）就是等价的。此外，（3）对于任意状态空间都蕴含（1）。存在一些弱正则性假设可确保（1）蕴含（3）（详见附录A.3）。在本文中，我们假设这些条件成立，即假设（3）蕴含（1）。

据我们所知，目前尚无关于抽象一般状态空间的已知结果能够确保在定理17中条件（3）可推出条件（1）。这就是我们在此处直接作出这一假设的原因。对于机器学习研究者而言，这一假设在任何相关的状态空间中都成立，因此无需担忧。

**流的伴随KFE**。让我们设定\(S=\mathbb{R}^{d}\)，并假设\(p_{t}\)相对于勒贝格测度具有有界且连续可微的密度\(p_{t}(x)\)。然后我们可以通过
\[\begin{aligned} \left< p_{t}, \mathcal{L}_{t} f\right> & =\mathbb{E}_{x \sim p_{t}}\left[\mathcal{L}_{t} f(x)\right] & & (8.48) \\ & =\int \mathcal{L}_{t} f(x) p_{t}(x) d x & & (8.49) \\ & \stackrel{(i)}{=} \int \nabla f(x)^{T} u_{t}(x) p_{t}(x) d x & & (8.50) \\ & \stackrel{(i i)}{=} \int f(x) \underbrace{\left[-div\left(p_{t} u_{t}\right)(x)\right]}_{=: \mathcal{L}_{t}^{*} p_{t}(x)} d x & & (8.51) \\ & =\int f(x) \mathcal{L}_{t}^{*} p_{t}(x) d x & & (8.52) \end{aligned}\]
计算伴随生成元\(L_{t}^{*}\)，其中（i）由方程（8.15）得出，（ii）通过分部积分得出。上述推导表明，伴随生成元由\(L_{t}^{*} p_{t}=-div(p_{t} u_{t})(x)\)给出（因为它满足方程（8.41）中的条件）。利用伴随KFE，我们得到连续性方程（参见方程（3.25））
\[\frac{d}{d t} p_{t}(x)=-div\left(p_{t} u_{t}\right)(x), (8.53)\]
，这是我们在3.4节中深入研究过的方程。

**扩散的伴随**。让我们设定\(S=\mathbb{R}^{d}\)，并假设\(p_{t}\)关于勒贝格测度具有密度\(p_{t}(x)\)，该密度有界且连续可微。我们可以通过下式来计算伴随生成元\(L_{t}^{*}\)

\[
\langle p_t, \mathcal{L}_t f \rangle = \mathbb{E}_{x \sim p_t}[\mathcal{L}_t f(x)] \tag{8.54}
\]

\[
= \int \mathcal{L}_t f(x) \, p_t(x) \, dx \tag{8.55}
\]

\[
\stackrel{(\text{i})}{=} \frac{1}{2} \int \sigma_t^2(x) \cdot \nabla^2 f(x) \, p_t(x) \, dx \tag{8.56}
\]

\[
\stackrel{(\text{ii})}{=} \int f(x) \, \underbrace{\frac{1}{2} \nabla^2 \cdot \left( p_t \sigma_t^2 \right)(x)}_{=: \mathcal{L}_t^* p_t(x)} \, dx \tag{8.57}
\]

\[
= \int f(x) \, \mathcal{L}_t^* p_t(x) \, dx \tag{8.58}
\]

以下是精准翻译（保留数学符号与专业术语，确保表意清晰）：  

由(i)可根据式(8.26)得到，(ii)可通过**两次分部积分**推导得出。上述推导表明，**伴随生成器**由 \( \mathcal{L}_t^* p_t = \frac{1}{2} \nabla^2 \cdot \left( p_t \sigma_t^2 \right)(x) \) 给出（因它满足式(8.41)中的条件 ）。进而，**伴随科尔莫戈罗夫前向方程（KFE）** 还原出了广为人知的**福克-普朗克方程** 。  

\[\frac{d}{d t} p_{t}(x)=\frac{1}{2} \nabla^{2} \cdot\left(p_{t} \sigma_{t}^{2}\right)(x) (8.59)\]

**跳跃的伴随KFE**。假设\(p_{t}\)具有关于勒贝格测度的密度\(p_{t}(x)\)，该密度有界且连续可微。假设跳跃测度\(Q_{t}(~d y, x)\)通过核\(Q_{t}: S ×S \to \mathbb{R}_{≥0},(y, x) \mapsto Q_{t}(y, x)\)给出，使得

\[\int f(y) Q_{t}( d y, x)=\int f(y) Q_{t}(y, x) \nu(d y) for all integrable f: \mathcal{S} \to \mathbb{R} . (8.60)\]

然后我们可以按如下方式推导伴随生成元：

\[\begin{align}
\langle \psi_t, \mathcal{L}_t f \rangle (x) &= \iint (f(y) - f(x)) Q_t(y, x) \nu(\mathrm{d}y) p_t(x) \nu(\mathrm{d}x) \tag{8.61} \\
&= \iint f(y) Q_t(y, x) p_t(x) \nu(\mathrm{d}y) \nu(\mathrm{d}x) - \iint f(x) Q_t(y, x) p_t(x) \nu(\mathrm{d}y) \nu(\mathrm{d}x) \tag{8.62} \\
&\stackrel{(\text{iii})}{=} \iint f(x) Q_t(x, y) p_t(y) \nu(\mathrm{d}y) \nu(\mathrm{d}x) - \iint f(x) Q_t(y, x) p_t(x) \nu(\mathrm{d}y) \nu(\mathrm{d}x) \tag{8.63} \\
&= \int f(x) \left[ \int Q_t(x, y) p_t(y) \nu(\mathrm{d}y) - \int Q_t(y, x) p_t(x) \nu(\mathrm{d}y) \right] \nu(\mathrm{d}x) \tag{8.64} \\
&= \int f(x) \mathcal{L}_t^* p_t(x) \nu(\mathrm{d}x) \tag{8.65}
\end{align}\]

其中（i）我们只是交换变量x和y。上述推导表明，如上所定义的\(L_{t}^{*}\)满足方程（8.41）中的条件，并且确实描述了跳跃的伴随生成元。据此，伴随KFE成为跳跃连续性方程：

$$\frac{\mathrm{d}}{\mathrm{d} t} p_{t}(x)=\int\left|Q_{t}(x, y) p_{t}(y)-Q_{t}(y, x) p_{t}(x)\right| \nu(\mathrm{d} y)=\int \lambda_{t}(y) J_{t}(x, y) p_{t}(y) \nu(\mathrm{d} y)-\lambda_{t}(x) p_{t}(x) \tag{8.66}$$

我们将\(Q_{t}(y, x)=\lambda_{t}(x) J_{t}(y, x)\)分解为跳跃强度\(\lambda_{t}\)和跳跃分布\(J_{t}\)（参见方程（8.28））。

连续时间马尔可夫链的伴随柯尔莫哥洛夫前向方程。对于离散的s和由\(f^{T} u_{t}\)给出的生成元（如方程（8.38）所示），我们得到

$$\begin{aligned}
\left\langle p_{t}, \mathcal{L}_{t} f\right\rangle &=\int p_{t}(x) \mathcal{L}_{t} f(x) \nu(\mathrm{d} x)=\sum_{x \in S} p_{t}(x) \sum_{y \in S} u_{t}(x, y) f(y) \\
&=\sum_{y \in S}\left[\sum_{x \in S} p_{t}(x) u_{t}(x, y)\right] f(y) \\
&=\sum_{y \in S} \mathcal{L}_{t}^{*} p_{t}(x) f(y) \\
&=\int \mathcal{L}_{t}^{*} p_{t}(y) f(y) \nu(\mathrm{d} y)
\end{aligned}$$

其中这里的\(\nu\)仅表示计数测度。因此，伴随的KFE简单地由下式给出

$$\frac{\mathrm{d}}{\mathrm{d} t} p_{t}(x)=\sum_{y \in S} u_{t}(x, y) p_{t}(y) \tag{8.67}$$

这重现了连续时间马尔可夫链（CTMCs）的柯尔莫哥洛夫前向方程（KFE），该方程在式（6.8）中推导得出（其中x和y进行了交换，以与本节中的推导保持一致）。

## 8.4 通用表示定理

生成器使我们能够描述可能的马尔可夫过程的空间。具体而言，以下结果不仅使我们能够描述一大类连续时间马尔可夫过程生成模型，还能详尽描述\(S=\mathbb{R}^{d}\)或离散s的设计空间。

**定理18**（生成元的泛性质刻画）。在弱正则性假设下，Feller过程\(X_{t}(0 ≤t ≤1)\)的生成元具有以下形式：

1. 离散\(|S|<\infty\)生成器由速率转移矩阵\(u_{t}\)给出，且马尔可夫过程对应一个连续时间马尔可夫链（CTMC）。

2. 欧几里得空间 \(S=\mathbb{R}^{d}\) 生成器可以表示为表2中描述的各分量之和，即

\[\mathcal{L}_{t} f(x)=\underbrace{\nabla f(x)^{T} u_{t}(x)}_{flow }+\underbrace{\frac{1}{2} \nabla^{2} f(x) \cdot \sigma_{t}^{2}(x)}_{diffusion }+\underbrace{\int[f(y)-f(x)] Q_{t}( d y, x)}_{jump } (8.68)\]

其中\(u:[0,1] ×\mathbb{R}^{d} \to \mathbb{R}^{d}\)是速度场，\(\sigma:[0,1] ×\mathbb{R}^{d} \to S_{d}^{++}\)是扩散系数（\((S_{d}^{++}\)表示半正定矩阵），\(Q_{t}(d y ; x)\)是跳跃测度；\(\nabla^{2} f(x)\)描述f的黑塞矩阵，\(\nabla^{2} f(x) \cdot \sigma_{t}^{2}(x)\)描述弗罗贝尼乌斯内积。

该证明改编自数学文献中的一个已知结果（Courrege，1965；von Waldenfels，1965），具体可参见（Holderrieth 等人，2024）。

